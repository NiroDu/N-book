<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ä» 0 å®ç° React SSR | N-book</title>
    <meta name="description" content="è®°å½•ä¸€äº›æŠ€æœ¯æ–¹é¢çš„æ–‡ç« ">
    <link rel="icon" href="/n-book/logo.png">
  <link rel="manifest" href="/n-book/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/n-book/assets/css/0.styles.8647af70.css" as="style"><link rel="preload" href="/n-book/assets/js/app.00669d2d.js" as="script"><link rel="preload" href="/n-book/assets/js/3.a2cc91fe.js" as="script"><link rel="prefetch" href="/n-book/assets/js/10.66c97b87.js"><link rel="prefetch" href="/n-book/assets/js/100.25cd6efd.js"><link rel="prefetch" href="/n-book/assets/js/11.d97ba4f9.js"><link rel="prefetch" href="/n-book/assets/js/12.8a7fa5f8.js"><link rel="prefetch" href="/n-book/assets/js/13.5c6c1dfb.js"><link rel="prefetch" href="/n-book/assets/js/14.c5caa02e.js"><link rel="prefetch" href="/n-book/assets/js/15.6bba582a.js"><link rel="prefetch" href="/n-book/assets/js/16.15881af1.js"><link rel="prefetch" href="/n-book/assets/js/17.58f3bf6d.js"><link rel="prefetch" href="/n-book/assets/js/18.41a59aa0.js"><link rel="prefetch" href="/n-book/assets/js/19.372839fc.js"><link rel="prefetch" href="/n-book/assets/js/20.366470b6.js"><link rel="prefetch" href="/n-book/assets/js/21.64ee41da.js"><link rel="prefetch" href="/n-book/assets/js/22.037051e6.js"><link rel="prefetch" href="/n-book/assets/js/23.aaf071e1.js"><link rel="prefetch" href="/n-book/assets/js/24.9323b659.js"><link rel="prefetch" href="/n-book/assets/js/25.efd078a6.js"><link rel="prefetch" href="/n-book/assets/js/26.e088dd56.js"><link rel="prefetch" href="/n-book/assets/js/27.23686290.js"><link rel="prefetch" href="/n-book/assets/js/28.7561d341.js"><link rel="prefetch" href="/n-book/assets/js/29.c2bccad7.js"><link rel="prefetch" href="/n-book/assets/js/30.e41777e5.js"><link rel="prefetch" href="/n-book/assets/js/31.8fa8342a.js"><link rel="prefetch" href="/n-book/assets/js/32.4a720fec.js"><link rel="prefetch" href="/n-book/assets/js/33.f4bcb093.js"><link rel="prefetch" href="/n-book/assets/js/34.b319e6cc.js"><link rel="prefetch" href="/n-book/assets/js/35.349f48cb.js"><link rel="prefetch" href="/n-book/assets/js/36.40f0f5b8.js"><link rel="prefetch" href="/n-book/assets/js/37.d825f129.js"><link rel="prefetch" href="/n-book/assets/js/38.03ef6cd3.js"><link rel="prefetch" href="/n-book/assets/js/39.5616fe5e.js"><link rel="prefetch" href="/n-book/assets/js/4.5c88fff9.js"><link rel="prefetch" href="/n-book/assets/js/40.06b60369.js"><link rel="prefetch" href="/n-book/assets/js/41.c8f4431f.js"><link rel="prefetch" href="/n-book/assets/js/42.611e129f.js"><link rel="prefetch" href="/n-book/assets/js/43.090fb933.js"><link rel="prefetch" href="/n-book/assets/js/44.95113469.js"><link rel="prefetch" href="/n-book/assets/js/45.7fd92109.js"><link rel="prefetch" href="/n-book/assets/js/46.411b0cb5.js"><link rel="prefetch" href="/n-book/assets/js/47.c4ed96a6.js"><link rel="prefetch" href="/n-book/assets/js/48.363d6e9d.js"><link rel="prefetch" href="/n-book/assets/js/49.a6580a6f.js"><link rel="prefetch" href="/n-book/assets/js/5.7ed2b6ce.js"><link rel="prefetch" href="/n-book/assets/js/50.80fdc641.js"><link rel="prefetch" href="/n-book/assets/js/51.9fca5b30.js"><link rel="prefetch" href="/n-book/assets/js/52.7a12bef7.js"><link rel="prefetch" href="/n-book/assets/js/53.0a0223c1.js"><link rel="prefetch" href="/n-book/assets/js/54.f5e1f5f6.js"><link rel="prefetch" href="/n-book/assets/js/55.3942d1de.js"><link rel="prefetch" href="/n-book/assets/js/56.6edb51e4.js"><link rel="prefetch" href="/n-book/assets/js/57.ea4bffdf.js"><link rel="prefetch" href="/n-book/assets/js/58.e7e0ee95.js"><link rel="prefetch" href="/n-book/assets/js/59.4098f04a.js"><link rel="prefetch" href="/n-book/assets/js/6.b2aebbbe.js"><link rel="prefetch" href="/n-book/assets/js/60.db12ab5e.js"><link rel="prefetch" href="/n-book/assets/js/61.031fb8bd.js"><link rel="prefetch" href="/n-book/assets/js/62.329f47c4.js"><link rel="prefetch" href="/n-book/assets/js/63.b2f2abcc.js"><link rel="prefetch" href="/n-book/assets/js/64.dc588d61.js"><link rel="prefetch" href="/n-book/assets/js/65.d599496d.js"><link rel="prefetch" href="/n-book/assets/js/66.69417e8c.js"><link rel="prefetch" href="/n-book/assets/js/67.d93755f8.js"><link rel="prefetch" href="/n-book/assets/js/68.f25092ea.js"><link rel="prefetch" href="/n-book/assets/js/69.2de4fe7c.js"><link rel="prefetch" href="/n-book/assets/js/7.157f3540.js"><link rel="prefetch" href="/n-book/assets/js/70.282e9d03.js"><link rel="prefetch" href="/n-book/assets/js/71.504f689e.js"><link rel="prefetch" href="/n-book/assets/js/72.a2d94f4f.js"><link rel="prefetch" href="/n-book/assets/js/73.07c4c964.js"><link rel="prefetch" href="/n-book/assets/js/74.89c222e9.js"><link rel="prefetch" href="/n-book/assets/js/75.820bdfb7.js"><link rel="prefetch" href="/n-book/assets/js/76.2407d5c9.js"><link rel="prefetch" href="/n-book/assets/js/77.ec939a5f.js"><link rel="prefetch" href="/n-book/assets/js/78.07709c00.js"><link rel="prefetch" href="/n-book/assets/js/79.cc7a4faa.js"><link rel="prefetch" href="/n-book/assets/js/8.c2fc7b68.js"><link rel="prefetch" href="/n-book/assets/js/80.fd9ef1eb.js"><link rel="prefetch" href="/n-book/assets/js/81.df45910d.js"><link rel="prefetch" href="/n-book/assets/js/82.450bb3f2.js"><link rel="prefetch" href="/n-book/assets/js/83.32c188fc.js"><link rel="prefetch" href="/n-book/assets/js/84.294bd5d9.js"><link rel="prefetch" href="/n-book/assets/js/85.6de4096a.js"><link rel="prefetch" href="/n-book/assets/js/86.0954b5d1.js"><link rel="prefetch" href="/n-book/assets/js/87.e7762817.js"><link rel="prefetch" href="/n-book/assets/js/88.97035a60.js"><link rel="prefetch" href="/n-book/assets/js/89.53a151f5.js"><link rel="prefetch" href="/n-book/assets/js/9.e94df2f4.js"><link rel="prefetch" href="/n-book/assets/js/90.a6f97b09.js"><link rel="prefetch" href="/n-book/assets/js/91.22f24c28.js"><link rel="prefetch" href="/n-book/assets/js/92.75844e0d.js"><link rel="prefetch" href="/n-book/assets/js/93.d6922f54.js"><link rel="prefetch" href="/n-book/assets/js/94.3dd08f5f.js"><link rel="prefetch" href="/n-book/assets/js/95.6a4c80ba.js"><link rel="prefetch" href="/n-book/assets/js/96.c25099ac.js"><link rel="prefetch" href="/n-book/assets/js/97.1e5183d7.js"><link rel="prefetch" href="/n-book/assets/js/98.bbdf3f45.js"><link rel="prefetch" href="/n-book/assets/js/99.a020358d.js"><link rel="prefetch" href="/n-book/assets/js/vendors~docsearch.8bf892cf.js">
    <link rel="stylesheet" href="/n-book/assets/css/0.styles.8647af70.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/n-book/" class="home-link router-link-active"><!----> <span class="site-name">N-book</span></a> <div class="links" style="max-width:nullpx;"><form id="search-form" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/n-book/" class="nav-link">Home</a></div><div class="nav-item"><a href="/n-book/typescript/" class="nav-link">TypeScript</a></div><div class="nav-item"><a href="/n-book/python/" class="nav-link">Python</a></div><div class="nav-item"><a href="https://nirodu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/NiroDu/N-book" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/n-book/" class="nav-link">Home</a></div><div class="nav-item"><a href="/n-book/typescript/" class="nav-link">TypeScript</a></div><div class="nav-item"><a href="/n-book/python/" class="nav-link">Python</a></div><div class="nav-item"><a href="https://nirodu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/NiroDu/N-book" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span></span> <!----></p> <ul class="sidebar-group-items"><li><a href="/n-book/" class="sidebar-link">ğŸ“–</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>JavaScriptsä¸“æ </span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>React ä¸“æ </span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/n-book/react/react_basic.html" class="sidebar-link">React åŸºç¡€éƒ¨åˆ†</a></li><li><a href="/n-book/react/redux_basic.html" class="sidebar-link">Redux åŸºç¡€éƒ¨åˆ†</a></li><li><a href="/n-book/react/redux_intermediate.html" class="sidebar-link">Redux ä¸­çº§éƒ¨åˆ†</a></li><li><a href="/n-book/react/libs_with_react.html" class="sidebar-link">Libs with React</a></li><li><a href="/n-book/react/react_ssr.html" class="active sidebar-link">ä» 0 å®ç° React SSR</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#ä»€ä¹ˆæ˜¯æœåŠ¡ç«¯æ¸²æŸ“ï¼Ÿ" class="sidebar-link">ä»€ä¹ˆæ˜¯æœåŠ¡ç«¯æ¸²æŸ“ï¼Ÿ</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#åœ¨æœåŠ¡å™¨ç«¯ç¼–å†™-react-ç»„ä»¶" class="sidebar-link">åœ¨æœåŠ¡å™¨ç«¯ç¼–å†™ React ç»„ä»¶</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#ç¼–å†™-webpack-4-çš„é…ç½®æ–‡ä»¶" class="sidebar-link">ç¼–å†™ webpack 4 çš„é…ç½®æ–‡ä»¶</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#babel" class="sidebar-link">Babel</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#css" class="sidebar-link">CSS</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#webpack-çš„è‡ªåŠ¨æ‰“åŒ…ä¸æœåŠ¡å™¨è‡ªåŠ¨é‡å¯" class="sidebar-link">Webpack çš„è‡ªåŠ¨æ‰“åŒ…ä¸æœåŠ¡å™¨è‡ªåŠ¨é‡å¯</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#npm-run-all" class="sidebar-link">npm-run-all</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#webpack-merge-ä¼˜åŒ–" class="sidebar-link">webpack-merge ä¼˜åŒ–</a></li></ul></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#å®ç°æœåŠ¡å™¨ç«¯ç»„ä»¶æ¸²æŸ“" class="sidebar-link">å®ç°æœåŠ¡å™¨ç«¯ç»„ä»¶æ¸²æŸ“</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#åŒæ„çš„æ¦‚å¿µæ¢³ç†" class="sidebar-link">åŒæ„çš„æ¦‚å¿µæ¢³ç†</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#ä»€ä¹ˆæ˜¯åŒæ„ï¼Ÿ" class="sidebar-link">ä»€ä¹ˆæ˜¯åŒæ„ï¼Ÿ</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#ä¸ºä»€ä¹ˆè¦æœ‰åŒæ„ï¼Ÿ" class="sidebar-link">ä¸ºä»€ä¹ˆè¦æœ‰åŒæ„ï¼Ÿ</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#å¦‚ä½•åœ¨æµè§ˆå™¨ä¸Šæ‰§è¡Œä¸€æ®µ-js-ä»£ç ï¼Ÿ" class="sidebar-link">å¦‚ä½•åœ¨æµè§ˆå™¨ä¸Šæ‰§è¡Œä¸€æ®µ JS ä»£ç ï¼Ÿ</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#è®©-react-ä»£ç åœ¨æµè§ˆå™¨ä¸Šè¿è¡Œ" class="sidebar-link">è®© React ä»£ç åœ¨æµè§ˆå™¨ä¸Šè¿è¡Œ</a></li></ul></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#åœ¨-ssr-æ¡†æ¶ä¸­å¼•å…¥è·¯ç”±æœºåˆ¶" class="sidebar-link">åœ¨ SSR æ¡†æ¶ä¸­å¼•å…¥è·¯ç”±æœºåˆ¶</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#è·¯ç”±é…ç½®æ–‡ä»¶ï¼š" class="sidebar-link">è·¯ç”±é…ç½®æ–‡ä»¶ï¼š</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#å®¢æˆ·ç«¯ä½¿ç”¨-browserrouter-è¿›è¡Œå®¢æˆ·ç«¯è·¯ç”±æ¸²æŸ“ï¼š" class="sidebar-link">å®¢æˆ·ç«¯ä½¿ç”¨ BrowserRouter è¿›è¡Œå®¢æˆ·ç«¯è·¯ç”±æ¸²æŸ“ï¼š</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#æœåŠ¡ç«¯çš„è·¯ç”±å†™æ³•ï¼š" class="sidebar-link">æœåŠ¡ç«¯çš„è·¯ç”±å†™æ³•ï¼š</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#ä½¿ç”¨linkæ ‡ç­¾ä¸²èµ·è·¯ç”±" class="sidebar-link">ä½¿ç”¨Linkæ ‡ç­¾ä¸²èµ·è·¯ç”±</a></li></ul></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#ssr-æ¡†æ¶ä¸-redux-çš„ç»“åˆ" class="sidebar-link">SSR æ¡†æ¶ä¸ Redux çš„ç»“åˆ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#åŒæ„é¡¹ç›®ä¸­å¼•å…¥-redux" class="sidebar-link">åŒæ„é¡¹ç›®ä¸­å¼•å…¥ Redux</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#æ„å»º-redux-ä»£ç ç»“æ„" class="sidebar-link">æ„å»º Redux ä»£ç ç»“æ„</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#å¼‚æ­¥æ•°æ®æœåŠ¡å™¨æ¸²æŸ“ï¼šloaddata-æ–¹æ³•åŠè·¯ç”±é‡æ„" class="sidebar-link">å¼‚æ­¥æ•°æ®æœåŠ¡å™¨æ¸²æŸ“ï¼šloadData æ–¹æ³•åŠè·¯ç”±é‡æ„</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#å¤šçº§è·¯ç”±é—®é¢˜çš„å¤„ç†" class="sidebar-link">å¤šçº§è·¯ç”±é—®é¢˜çš„å¤„ç†</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#æœåŠ¡å™¨ç«¯è·å–å¼‚æ­¥æ•°æ®ï¼Œæ¸²æŸ“åè¿”å›ç»™æµè§ˆå™¨" class="sidebar-link">æœåŠ¡å™¨ç«¯è·å–å¼‚æ­¥æ•°æ®ï¼Œæ¸²æŸ“åè¿”å›ç»™æµè§ˆå™¨</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#æ•°æ®çš„æ³¨æ°´å’Œè„±æ°´" class="sidebar-link">æ•°æ®çš„æ³¨æ°´å’Œè„±æ°´</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#ä¼˜åŒ–" class="sidebar-link">ä¼˜åŒ–</a></li></ul></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#ä½¿ç”¨-node-ä½œä¸ºæ•°æ®è·å–ä¸­é—´å±‚" class="sidebar-link">ä½¿ç”¨ Node ä½œä¸ºæ•°æ®è·å–ä¸­é—´å±‚</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#ä½¿ç”¨-proxy-ä»£ç†ï¼Œè®©ä¸­é—´å±‚æ‰¿æ‹…æ•°æ®è·å–èŒè´£" class="sidebar-link">ä½¿ç”¨ proxy ä»£ç†ï¼Œè®©ä¸­é—´å±‚æ‰¿æ‹…æ•°æ®è·å–èŒè´£</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#redux-thunk-ä¸­çš„-withextraargument" class="sidebar-link">redux-thunk ä¸­çš„ withExtraArgument</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#renderroutes-æ–¹æ³•å®ç°å¯¹å¤šçº§è·¯ç”±çš„æ”¯æŒ" class="sidebar-link">renderRoutes æ–¹æ³•å®ç°å¯¹å¤šçº§è·¯ç”±çš„æ”¯æŒ</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#ç™»é™†åŠŸèƒ½" class="sidebar-link">ç™»é™†åŠŸèƒ½</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#cookies-æºå¸¦é—®é¢˜" class="sidebar-link">cookies æºå¸¦é—®é¢˜</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#æ›¾ç»çš„é—®é¢˜ï¼šä»¤ä½ æ·±åˆ»çš„-bug" class="sidebar-link">æ›¾ç»çš„é—®é¢˜ï¼šä»¤ä½ æ·±åˆ»çš„ Bug ?</a></li></ul></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#ç»†èŠ‚é—®é¢˜å¤„ç†" class="sidebar-link">ç»†èŠ‚é—®é¢˜å¤„ç†</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#ç»Ÿä¸€ç®¡ç†å¯†é’¥" class="sidebar-link">ç»Ÿä¸€ç®¡ç†å¯†é’¥</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#_404-é¡µé¢" class="sidebar-link">404 é¡µé¢</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#å®ç°æœåŠ¡å™¨ç«¯-301-é‡å®šå‘" class="sidebar-link">å®ç°æœåŠ¡å™¨ç«¯ 301 é‡å®šå‘</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#å®¹é”™å¤„ç†æ•°æ®è¯·æ±‚å¤±è´¥æƒ…å†µä¸‹-promise-çš„å¤„ç†" class="sidebar-link">å®¹é”™å¤„ç†æ•°æ®è¯·æ±‚å¤±è´¥æƒ…å†µä¸‹ promise çš„å¤„ç†</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#ä¸€ä¸ª-loaddata-çš„æ½œåœ¨é—®é¢˜" class="sidebar-link">ä¸€ä¸ª loadData çš„æ½œåœ¨é—®é¢˜</a></li></ul></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#å¤„ç†-ssr-æ¡†æ¶ä¸­çš„-css-æ ·å¼" class="sidebar-link">å¤„ç† SSR æ¡†æ¶ä¸­çš„ CSS æ ·å¼</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#å®ç°-css-æ ·å¼çš„æœåŠ¡å™¨ç«¯æ¸²æŸ“" class="sidebar-link">å®ç° CSS æ ·å¼çš„æœåŠ¡å™¨ç«¯æ¸²æŸ“</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#å¤šç»„ä»¶ä¸­çš„æ ·å¼å¦‚ä½•æ•´åˆ" class="sidebar-link">å¤šç»„ä»¶ä¸­çš„æ ·å¼å¦‚ä½•æ•´åˆ</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#é«˜é˜¶ç»„ä»¶å°è£…æ¥ç²¾ç®€ä»£ç " class="sidebar-link">é«˜é˜¶ç»„ä»¶å°è£…æ¥ç²¾ç®€ä»£ç </a></li></ul></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#seo" class="sidebar-link">SEO</a></li><li class="sidebar-sub-header"><a href="/n-book/react/react_ssr.html#ä½¿ç”¨é¢„æ¸²æŸ“è§£å†³-seo-é—®é¢˜çš„æ–°æ€è·¯" class="sidebar-link">ä½¿ç”¨é¢„æ¸²æŸ“è§£å†³ SEO é—®é¢˜çš„æ–°æ€è·¯</a></li></ul></li><li><a href="/n-book/react/redux_createstore.html" class="sidebar-link">è®²è®² Redux createStore çš„å®ç°åŸç†</a></li><li><a href="/n-book/react/react_context.html" class="sidebar-link">React Context æ€ä¹ˆç”¨</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Vue ä¸“æ </span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Webpack ä¸“æ </span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>TypeScript ä¸“æ </span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>è‡ªåŠ¨åŒ–æµ‹è¯•</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>æ€§èƒ½ä¼˜åŒ–</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Interview ä¸“æ </span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>å…¶ä»–</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="ä»-0-å®ç°-react-ssr"><a href="#ä»-0-å®ç°-react-ssr" class="header-anchor">#</a> ä» 0 å®ç° React SSR</h1> <h2 id="ä»€ä¹ˆæ˜¯æœåŠ¡ç«¯æ¸²æŸ“ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯æœåŠ¡ç«¯æ¸²æŸ“ï¼Ÿ" class="header-anchor">#</a> ä»€ä¹ˆæ˜¯æœåŠ¡ç«¯æ¸²æŸ“ï¼Ÿ</h2> <p>SSRï¼šæœåŠ¡å™¨æŠŠé¡µé¢è¦å±•ç¤ºçš„å†…å®¹æå‰æ¸²æŸ“å¥½ï¼Œç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯å»å±•ç¤ºã€‚</p> <p>SSR ç¼ºç‚¹ï¼šå¾ˆæ¶ˆè€—æœåŠ¡å™¨çš„æ€§èƒ½ã€‚</p> <p>CSRï¼ˆClient Server Renderï¼‰å®¢æˆ·ç«¯æ¸²æŸ“ï¼šç”±å®¢æˆ·ç«¯æ¥æ¸²æŸ“é¡µé¢å†…å®¹ã€‚</p> <p>CSR ç¼ºç‚¹ï¼šTTFP é¦–å±å±•ç°æ—¶é—´æ…¢ï¼Œå¯¹ SEO ä¸å‹å¥½ã€‚</p> <p><img src="/n-book/assets/img/csr_ssr.36996d1d.png" alt="csr_ssr"></p> <p>CSR é¦–å±æ¸²æŸ“æ—¶é—´ä¸å¦‚ SSRã€‚</p> <p>CSR çš„ SEO æ•ˆæœä¸å¦‚ SSRã€‚ï¼ˆå› ä¸ºçˆ¬è™«åªèƒ½è¯»å–åˆ° html ä¸­çš„æ–‡æœ¬å†…å®¹ï¼Œè¯»å–ä¸åˆ° JS é‡Œçš„å†…å®¹ï¼Œè€Œ CSR æ˜¯ç”± JS æ‰§è¡Œåæ¸²æŸ“é¡µé¢å†…å®¹ã€‚ï¼‰</p> <h2 id="åœ¨æœåŠ¡å™¨ç«¯ç¼–å†™-react-ç»„ä»¶"><a href="#åœ¨æœåŠ¡å™¨ç«¯ç¼–å†™-react-ç»„ä»¶" class="header-anchor">#</a> åœ¨æœåŠ¡å™¨ç«¯ç¼–å†™ React ç»„ä»¶</h2> <p>ç”¨ React è¿›è¡Œçš„å®¢æˆ·ç«¯æ¸²æŸ“ï¼Œé¡µé¢è®¿é—®çš„æ‰§è¡Œé¡ºåºï¼š
<img src="/n-book/assets/img/flow_1.375584da.png" alt="flow_1"></p> <p>åœ¨æœåŠ¡å™¨ç«¯å†™ React ï¼Œé¡µé¢è®¿é—®çš„æ‰§è¡Œé¡ºåºï¼š
<img src="/n-book/assets/img/flow_2.63d33d37.png" alt="flow_2"></p> <p>Node ç¯å¢ƒä¸‹ä¸éµä» <strong>ESModule</strong> çš„å†™æ³•ï¼Œè€Œéµä» <strong>common.js</strong> çš„å†™æ³•ã€‚
æ‰€ä»¥ä¸èƒ½å†™</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">Home</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">home</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>è€Œæ˜¯è¦ <strong>common.js</strong> çš„å†™æ³•ï¼š</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">const</span> React <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;react&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// éœ€è¦ webpack ç¼–è¯‘æ‰“åŒ…å¥½ JSX è¯­æ³•å†…å®¹æ‰èƒ½ç”¨</span>
<span class="token keyword">const</span> <span class="token function-variable function">Home</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">home</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">default</span><span class="token punctuation">:</span> Home
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>ä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡ webpack ç¼–è¯‘æ‰“åŒ…ï¼Œæ¥ä½¿æˆ‘ä»¬ä¾ç„¶ä½¿ç”¨ <strong>ESModule</strong> çš„å†™æ³•ã€‚</p> <h2 id="ç¼–å†™-webpack-4-çš„é…ç½®æ–‡ä»¶"><a href="#ç¼–å†™-webpack-4-çš„é…ç½®æ–‡ä»¶" class="header-anchor">#</a> ç¼–å†™ webpack 4 çš„é…ç½®æ–‡ä»¶</h2> <p>å®‰è£… webpack cli: <a href="https://github.com/webpack/webpack-cli" target="_blank" rel="noopener noreferrer">https://github.com/webpack/webpack-cli<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save-dev webpack-cli
<span class="token function">yarn</span> <span class="token function">add</span> webpack-cli --dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="babel"><a href="#babel" class="header-anchor">#</a> Babel</h3> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token comment">//  /webpack.server.js;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> nodeExternals <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;webpack-node-externals&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// æŒ‡å®štargetæ˜¯nodeç¯å¢ƒï¼ŒåŸå› æ˜¯ä¾‹å¦‚const path = require('path');</span>
  <span class="token comment">// åœ¨nodeç¯å¢ƒä¸‹ä¸ä¼šå°†æ•´ä¸ªpathåŒ…å…¨éƒ¨å¼•å…¥ï¼Œè€Œåœ¨å®¢æˆ·ç«¯ç¯å¢ƒï¼ˆéœ€è¦ï¼‰ä¼šå°†æ•´ä¸ªpathåŒ…å…¨éƒ¨å¼•å…¥ã€‚</span>
  <span class="token comment">// æ‰€ä»¥éœ€è¦å£°æ˜ã€‚</span>
  target<span class="token punctuation">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span> <span class="token comment">// webpack4è¦æ±‚è¦å£°æ˜modeç¯å¢ƒ</span>
  mode<span class="token punctuation">:</span> <span class="token string">&quot;development&quot;</span><span class="token punctuation">,</span>
  entry<span class="token punctuation">:</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">,</span>
  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">:</span> <span class="token string">&quot;bundle.js&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// __dirname æŒ‡çš„æ˜¯æœåŠ¡å™¨ç«¯çš„æ ¹è·¯å¾„</span>
    <span class="token comment">// æ‰“åŒ…åçš„æ–‡ä»¶æ”¾åˆ°æ ¹è·¯å¾„ä¸‹çš„ build æ–‡ä»¶å¤¹</span>
    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;build&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// è¿è¡Œ nodeExternals</span>
  externals<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">nodeExternals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token punctuation">:</span> <span class="token regex">/\.js?$/</span><span class="token punctuation">,</span>
        <span class="token comment">// è¦ä½¿ç”¨ babel-loaderï¼Œè¿˜éœ€è¦å®‰è£…å®ƒçš„æ ¸å¿ƒåº“ babel-core</span>
        <span class="token comment">// npm install babel-loader babel-core --save</span>
        loader<span class="token punctuation">:</span> <span class="token string">&quot;babel-loader&quot;</span><span class="token punctuation">,</span>
        exclude<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>
        options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token comment">// éœ€è¦å®‰è£…babel-preset-reactæ¥ä½¿å¾—babel-loaderèƒ½ç¼–è¯‘reactä»£ç </span>
          <span class="token comment">// babel-preset-stage-0,babel-preset-envæ˜¯è¾…åŠ©ç¼–è¯‘reactçš„</span>
          <span class="token comment">// éƒ½éœ€è¦å®‰è£…</span>
          presets<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;react&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;stage-0&quot;</span><span class="token punctuation">,</span>
            <span class="token comment">// æ‰“åŒ…ç¼–è¯‘æ—¶ï¼Œbabelä¼šå»å…¼å®¹æ‰€æœ‰ä¸»æµæµè§ˆå™¨çš„æœ€åä¸¤ä¸ªç‰ˆæœ¬</span>
            <span class="token comment">// éœ€è¦å®‰è£… npm install babel-preset-env --save æ¥è®¾ç½®envå˜é‡</span>
            <span class="token punctuation">[</span>
              <span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span>
              <span class="token punctuation">{</span>
                targets<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                  browsers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;last 2 versions&quot;</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>ä½¿ç”¨ä¸‹é¢è¿™æ¡å‘½ä»¤ï¼Œä½¿ webpack ç”¨æˆ‘ä»¬æŒ‡å®šçš„é…ç½®æ–‡ä»¶è¿›è¡Œæ‰“åŒ…ã€‚</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ webpack --config webpack.server.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>è¿è¡Œå¯èƒ½ä¼šæŠ¥å¦‚ä¸‹è­¦å‘Šï¼š
<img src="/n-book/assets/img/warning_1.d4ac2578.png" alt="warning_1">
åœ¨æœåŠ¡å™¨ç«¯é™¤äº†è¦å£°æ˜ target: &quot;node&quot;ï¼Œè¿˜éœ€è¦å®‰è£… <strong>webpack-node-externals</strong>ï¼Œä½¿å¾—ä»£ç ä¸­å¼•å…¥çš„ç¬¬ä¸‰æ–¹çš„åº“ï¼ˆå¦‚ koaã€expressï¼‰ä¸è¢«æ‰“åŒ…è¿› bundled.js é‡Œï¼Œè¿˜æ˜¯ä¼šåœ¨ node modules ä¸­åŠ è½½ã€‚</p> <p>æ–‡æ¡£ï¼š<a href="https://github.com/liady/webpack-node-externals" target="_blank" rel="noopener noreferrer">https://github.com/liady/webpack-node-externals<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="css"><a href="#css" class="header-anchor">#</a> CSS</h3> <p>webpack css å®¢æˆ·ç«¯æ‰“åŒ…ç¼–è¯‘éœ€è¦å®‰è£… style-loader å’Œ css-loaderã€‚</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">yarn</span> <span class="token function">add</span> style-loader css-loader
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>åœ¨æœåŠ¡å™¨æ¸²æŸ“æ—¶ï¼Œä½¿ç”¨ style-loader ä¼šæŠ¥ä»¥ä¸‹é”™è¯¯ï¼Œå› ä¸ºæœåŠ¡ç«¯ä¸Šæ²¡æœ‰ window å¯¹è±¡ã€‚
<img src="/n-book/assets/img/error_1.15ac692b.png" alt="error_1"></p> <p>æ‰€ä»¥æœåŠ¡ç«¯æ¸²æŸ“æ—¶ï¼ŒCSS æ‰“åŒ…ä½¿ç”¨ isomorphic æ¥ä»£æ›¿ style-loaderã€‚
<a href="https://github.com/kriasoft/isomorphic-style-loader" target="_blank" rel="noopener noreferrer">https://github.com/kriasoft/isomorphic-style-loader<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>åˆ†åˆ«é…ç½®å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ webpack æ–‡ä»¶ï¼š</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// /webpack.client.js</span>
<span class="token keyword">const</span> clientConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token punctuation">:</span> <span class="token string">&quot;development&quot;</span><span class="token punctuation">,</span>
  entry<span class="token punctuation">:</span> <span class="token string">&quot;./src/client/index.js&quot;</span><span class="token punctuation">,</span>
  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;public&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token punctuation">:</span> <span class="token regex">/\.css?$/</span><span class="token punctuation">,</span>
        use<span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token string">&quot;style-loader&quot;</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            loader<span class="token punctuation">:</span> <span class="token string">&quot;css-loader&quot;</span><span class="token punctuation">,</span>
            options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
              importLoaders<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
              modules<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              localIdentName<span class="token punctuation">:</span> <span class="token string">&quot;[name]_[local]_[hash:base64:5]&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token comment">// /webpack.server.js</span>
<span class="token keyword">const</span> serverConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  target<span class="token punctuation">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span>
  mode<span class="token punctuation">:</span> <span class="token string">&quot;development&quot;</span><span class="token punctuation">,</span>
  entry<span class="token punctuation">:</span> <span class="token string">&quot;./src/server/index.js&quot;</span><span class="token punctuation">,</span>
  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">:</span> <span class="token string">&quot;bundle.js&quot;</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;build&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  externals<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">nodeExternals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token punctuation">:</span> <span class="token regex">/\.css?$/</span><span class="token punctuation">,</span>
        use<span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token string">&quot;isomorphic-style-loader&quot;</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            loader<span class="token punctuation">:</span> <span class="token string">&quot;css-loader&quot;</span><span class="token punctuation">,</span>
            options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
              importLoaders<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
              modules<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              localIdentName<span class="token punctuation">:</span> <span class="token string">&quot;[name]_[local]_[hash:base64:5]&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>ä½†æ˜¯è¿™ç§åšæ³•ä¹Ÿåªæ˜¯å¯ä»¥æˆåŠŸæ‰“åŒ…åœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶çš„ CSS ä»£ç ï¼Œé¡µé¢ä¸Šæ˜¾ç¤ºçš„è¿˜æ˜¯å®¢æˆ·ç«¯æ¸²æŸ“çš„ CSSã€‚æƒ³è¦æœåŠ¡ç«¯æ¸²æŸ“æ—¶å°±æŠŠ CSS ä»£ç æ‰“åŒ…å¥½ï¼Œå‚è€ƒä¸‹æ–¹çš„å°èŠ‚å†…å®¹ï¼š<strong>å¤„ç† SSR æ¡†æ¶ä¸­çš„ CSS æ ·å¼- å®ç° CSS æ ·å¼çš„æœåŠ¡å™¨ç«¯æ¸²æŸ“ã€‚</strong></p> <h3 id="webpack-çš„è‡ªåŠ¨æ‰“åŒ…ä¸æœåŠ¡å™¨è‡ªåŠ¨é‡å¯"><a href="#webpack-çš„è‡ªåŠ¨æ‰“åŒ…ä¸æœåŠ¡å™¨è‡ªåŠ¨é‡å¯" class="header-anchor">#</a> Webpack çš„è‡ªåŠ¨æ‰“åŒ…ä¸æœåŠ¡å™¨è‡ªåŠ¨é‡å¯</h3> <p>nodemon is a tool that helps develop node.js based applications by automatically restarting the node application when file changes in the directory are detected.</p> <p>å…¨å±€å®‰è£…ï¼š</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">yarn</span> global <span class="token function">add</span> nodemon
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>æ–‡æ¡£ï¼š<a href="https://github.com/remy/nodemon" target="_blank" rel="noopener noreferrer">https://github.com/remy/nodemon<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>é…ç½®æ–°å‘½ä»¤ï¼š
server/package.json</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon --watch build --exec node \&quot;./build/bundle.js\&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack --config webpack.server.js --watch&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>webpack å‘½ä»¤è¿½åŠ  <code>--watch</code> å‚æ•°ï¼Œæ„æ€æ˜¯ç›‘å¬ webpack.server.js é…ç½®çš„æ–‡ä»¶çš„å˜åŒ–ï¼Œä¸€æ—¦å‘ç”Ÿå˜åŒ–å°±é‡æ–° build æ‰“åŒ…ä¸€æ¬¡ä»£ç ã€‚ä½†æ˜¯è¿™åªæ˜¯é‡æ–°æ‰“åŒ…äº†æ–°çš„ bundled.jsï¼Œå¹¶æ²¡æœ‰é‡å¯æœåŠ¡å™¨ï¼Œæ‰€ä»¥é¡µé¢æ˜¾ç¤ºçš„è¿˜æ˜¯æ—§çš„å†…å®¹ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦é…åˆç€ nodemon æ¥ä½¿ç”¨ã€‚</p> <p>start å‘½ä»¤çš„æ„æ€æ˜¯ nodemon ç›‘å¬ build æ–‡ä»¶å¤¹ï¼Œä¸€æ—¦ build æ–‡ä»¶å¤¹å‘ç”Ÿäº†æ›´æ”¹ï¼Œå°±æ‰§è¡Œ<code>node &quot;./build/bundle.js&quot;</code>å‘½ä»¤ï¼Œé‡å¯æœåŠ¡å™¨ã€‚</p> <h3 id="npm-run-all"><a href="#npm-run-all" class="header-anchor">#</a> npm-run-all</h3> <p>ä¸Šé¢è‡ªåŠ¨æ‰“åŒ…å’ŒæœåŠ¡å™¨è‡ªåŠ¨é‡å¯æ˜¯ä¸¤æ¡å‘½ä»¤ï¼Œéœ€è¦ä¸¤ä¸ªç»ˆç«¯çª—å£å»åˆ†åˆ«æ‰§è¡Œï¼Œå¤ªéº»çƒ¦ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©ç¬¬ä¸‰æ–¹å·¥å…·ä½¿ä¹‹åˆå¹¶ä¸ºä¸€ä¸ªå‘½ä»¤ã€‚</p> <p><strong>å…¨å±€å®‰è£… npm-run-all</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">yarn</span> global <span class="token function">add</span> npm-run-all
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>æ–‡æ¡£ï¼š<a href="https://github.com/mysticatea/npm-run-all" target="_blank" rel="noopener noreferrer">https://github.com/mysticatea/npm-run-all<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>æ”¹å†™å‘½ä»¤ï¼Œ<code>npm-run-all --parallel dev:**</code> çš„æ„æ€æ˜¯ï¼Œå¹¶è¡Œçš„æ‰§è¡Œæ‰€æœ‰ä»¥ dev: å¼€å¤´çš„å‘½ä»¤ã€‚</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm-run-all --parallel dev:**&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dev:start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon --watch build --exec node \&quot;./build/bundle.js\&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dev:build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack --config webpack.server.js --watch&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="webpack-merge-ä¼˜åŒ–"><a href="#webpack-merge-ä¼˜åŒ–" class="header-anchor">#</a> webpack-merge ä¼˜åŒ–</h3> <p>å¯ä»¥ç”¨ webpack-merge å»åˆå¹¶ webpack ä¸­é‡å¤çš„é…ç½®é¡¹ã€‚</p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token comment">// /webpack.server.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> nodeExternals <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;webpack-node-externals&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> merge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;webpack-merge&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./webpack.base.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> serverConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  target<span class="token punctuation">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span>
  mode<span class="token punctuation">:</span> <span class="token string">&quot;development&quot;</span><span class="token punctuation">,</span>
  entry<span class="token punctuation">:</span> <span class="token string">&quot;./src/server/index.js&quot;</span><span class="token punctuation">,</span>
  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">:</span> <span class="token string">&quot;bundle.js&quot;</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;build&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  externals<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">nodeExternals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> serverConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>./webpack.base.js å¯¼å‡ºä¸€ä¸ªå¯¹è±¡ï¼Œmerge æ–¹æ³•å»åˆå¹¶ config å¯¹è±¡å’Œ serverConfig å¯¹è±¡ã€‚</p> <h2 id="å®ç°æœåŠ¡å™¨ç«¯ç»„ä»¶æ¸²æŸ“"><a href="#å®ç°æœåŠ¡å™¨ç«¯ç»„ä»¶æ¸²æŸ“" class="header-anchor">#</a> å®ç°æœåŠ¡å™¨ç«¯ç»„ä»¶æ¸²æŸ“</h2> <p>åŸæ¥å®¢æˆ·ç«¯æ¸²æŸ“çš„æ¨¡å¼ï¼š</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">&quot;react-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">&quot;./App&quot;</span><span class="token punctuation">;</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>åœ¨æœåŠ¡å™¨ç«¯å¹¶ä¸èƒ½ç›´æ¥ ReactDOM.render() å»å–èŠ‚ç‚¹æ¸²æŸ“ã€‚</p> <p>ä½† react-dom æä¾›äº†æœåŠ¡å™¨ç«¯æ¸²æŸ“çš„æ–¹æ³•ï¼š<strong>renderToString</strong> ï¼ˆå°†ç»„ä»¶æ¸²æŸ“æˆå­—ç¬¦ä¸²è¿”å›ï¼‰</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted">Â </div><br><br><div class="highlighted">Â </div><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/index.js</span>
<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">&quot;express&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Home <span class="token keyword">from</span> <span class="token string">&quot;./containers/Home&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// åœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“ react ç»„ä»¶</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> renderToString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-dom/server&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Home</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
		&lt;html&gt;
			&lt;head&gt;
				&lt;title&gt;ssr&lt;/title&gt;
			&lt;/head&gt;
			&lt;body&gt;
				</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
			&lt;/body&gt;
		&lt;/html&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> server <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><strong>React çš„è™šæ‹Ÿ DOM ä½¿å¾—æœåŠ¡å™¨æ¸²æŸ“æ›´ç®€å•ï¼Œå®ƒæ˜¯å»ºç«‹åœ¨è™šæ‹Ÿ DOM ä¸Šçš„æœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼Œå°±æ˜¯ä¸€ä¸ª JS å¯¹è±¡(è™šæ‹Ÿ DOM)è½¬æˆå­—ç¬¦ä¸²è¿”å›å»ã€‚</strong></p> <h2 id="åŒæ„çš„æ¦‚å¿µæ¢³ç†"><a href="#åŒæ„çš„æ¦‚å¿µæ¢³ç†" class="header-anchor">#</a> åŒæ„çš„æ¦‚å¿µæ¢³ç†</h2> <h3 id="ä»€ä¹ˆæ˜¯åŒæ„ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯åŒæ„ï¼Ÿ" class="header-anchor">#</a> ä»€ä¹ˆæ˜¯åŒæ„ï¼Ÿ</h3> <p>ä¸€å¥— React ä»£ç ï¼Œåœ¨æœåŠ¡å™¨ç«¯æ‰§è¡Œä¸€æ¬¡ï¼Œåœ¨å®¢æˆ·ç«¯å†æ‰§è¡Œä¸€æ¬¡ã€‚
<img src="/n-book/assets/img/flow_3.41504aeb.png" alt="flow_3"></p> <h3 id="ä¸ºä»€ä¹ˆè¦æœ‰åŒæ„ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦æœ‰åŒæ„ï¼Ÿ" class="header-anchor">#</a> ä¸ºä»€ä¹ˆè¦æœ‰åŒæ„ï¼Ÿ</h3> <p>å‡å¦‚æˆ‘ä»¬æƒ³ç‚¹å‡» button æ—¶æ‰§è¡Œç»‘å®šåœ¨ä¸Šé¢çš„ JS è¯­å¥ï¼Œä½†æœåŠ¡å™¨æ¸²æŸ“æ—¶ï¼Œç»„ä»¶ä¸Šç»‘å®šçš„ JS è¯­å¥è¿”å›ç»™å®¢æˆ·ç«¯æ—¶ä¼šè¢«åˆ æ‰ã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/containers/Home/index.js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Home</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">This is HOME!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span>
        <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;click1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
      <span class="token punctuation">&gt;</span></span><span class="token plain-text">
        click
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Home<span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token comment">// src/index.js</span>
<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">&quot;express&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> renderToString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-dom/server&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Home <span class="token keyword">from</span> <span class="token string">&quot;../containers/Home&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">&quot;public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Home</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
		&lt;html&gt;
			&lt;head&gt;
				&lt;title&gt;ssr&lt;/title&gt;
			&lt;/head&gt;
			&lt;body&gt;
				&lt;div id=&quot;root&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div&gt;
			&lt;/body&gt;
		&lt;/html&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> server <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>å¦‚ä¸Šé¢ button çš„ alert è¯­å¥ï¼Œæ¸²æŸ“åˆ°é¡µé¢æ—¶å·²è¢«åˆ é™¤ã€‚å› ä¸º renderToString æ–¹æ³•åªä¼šæ¸²æŸ“ç»„ä»¶çš„åŸºç¡€å†…å®¹ï¼Œä¸ä¼šæ¸²æŸ“äº‹ä»¶ã€‚
<img src="/n-book/assets/img/source_1.80e3e0cc.png" alt="source_1"></p> <p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæå‡º<strong>åŒæ„</strong>è¿™ç§åšæ³•ã€‚</p> <h3 id="å¦‚ä½•åœ¨æµè§ˆå™¨ä¸Šæ‰§è¡Œä¸€æ®µ-js-ä»£ç ï¼Ÿ"><a href="#å¦‚ä½•åœ¨æµè§ˆå™¨ä¸Šæ‰§è¡Œä¸€æ®µ-js-ä»£ç ï¼Ÿ" class="header-anchor">#</a> å¦‚ä½•åœ¨æµè§ˆå™¨ä¸Šæ‰§è¡Œä¸€æ®µ JS ä»£ç ï¼Ÿ</h3> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token comment">// src/index.js</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">&quot;public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>åœ¨ express ä¸­æä¾›äº†è¿™æ ·çš„æ–¹æ³•ï¼Œä½¿ç”¨ use() ä½¿ç”¨ä¸­é—´ä»¶ï¼Œ<code>express.static('public')</code> æ„æ€æ˜¯å‡å¦‚è®¿é—®çš„æ˜¯ä¸€ä¸ªé™æ€æ–‡ä»¶ï¼Œå°±ä¼šåˆ°æ ¹ç›®å½•ä¸‹çš„ public æ–‡ä»¶å¤¹å»è·å–é™æ€èµ„æºã€‚</p> <p>å¹¶ä¸”æˆ‘ä»¬åœ¨ webpack é…ç½®äº†å®¢æˆ·ç«¯çš„æ–‡ä»¶ä¼šè¢«æ‰“åŒ…åˆ° public æ–‡ä»¶å¤¹ä¸‹ï¼Œè¿™æ ·å°±æœ‰äº†è§£å†³çš„ä¸€ç§æ–¹å¼ï¼š</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// ...</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
		&lt;html&gt;
			&lt;head&gt;
				&lt;title&gt;ssr&lt;/title&gt;
			&lt;/head&gt;
			&lt;body&gt;
				&lt;div id=&quot;root&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div&gt;
				&lt;script src='/index.js'&gt;&lt;/script&gt;
			&lt;/body&gt;
		&lt;/html&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>åŒæ„è¿‡ç¨‹ï¼šè®¿é—® localhost:3000ï¼Œå¯ä»¥è·å¾—æœåŠ¡å™¨ç«¯æ¸²æŸ“çš„å†…å®¹ï¼Œç„¶åè¿›è¡Œå®¢æˆ·ç«¯çš„æ¸²æŸ“ã€‚</p> <p>åœ¨é¡µé¢ä¸­çš„ <code>&lt;script src='/index.js'&gt;&lt;/script&gt;</code> ä¼šå¼•å…¥ index.js æ–‡ä»¶ï¼Œå¹¶ä¸”æ‰§è¡Œé‡Œé¢çš„ JS å†…å®¹ï¼ˆå®¢æˆ·ç«¯åŠ è½½ JSï¼‰ã€‚</p> <h3 id="è®©-react-ä»£ç åœ¨æµè§ˆå™¨ä¸Šè¿è¡Œ"><a href="#è®©-react-ä»£ç åœ¨æµè§ˆå™¨ä¸Šè¿è¡Œ" class="header-anchor">#</a> è®© React ä»£ç åœ¨æµè§ˆå™¨ä¸Šè¿è¡Œ</h3> <blockquote><p>åŒæ„æ€è·¯ï¼šæˆ‘ä»¬åœ¨ src ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª client ç›®å½•ï¼Œä¸“é—¨å­˜æ”¾å®¢æˆ·ç«¯æ¸²æŸ“è¦æ‰§è¡Œçš„ä»£ç ï¼ˆclient/index.jsï¼‰ï¼Œå¹¶ä¸”ç”¨ webpack.client.js å°†å…¶æ‰“åŒ…ç¼–è¯‘åˆ°æ ¹ç›®å½•çš„ public æ–‡ä»¶å¤¹ä¸‹ã€‚ï¼ˆæµè§ˆå™¨é‡Œæ˜¯ä¸ç›´æ¥æ”¯æŒ esmodule çš„å†™æ³•çš„ï¼Œæ‰€ä»¥è¦ç”¨ webpack ç¼–è¯‘ï¼‰</p></blockquote> <blockquote><p>åœ¨æœåŠ¡ç«¯æ¸²æŸ“å®Œåé¡µé¢ç»™æµè§ˆå™¨åï¼Œæµè§ˆå™¨ä¼šå»æ‰§è¡Œ <code>&lt;script src='/index.js'&gt;&lt;/script&gt;</code> è®¿é—® /index.js æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥è®¿é—® public æ–‡ä»¶å¤¹ä¸‹çš„ index.jsï¼Œæµè§ˆå™¨å°±åˆé‡æ–°åŠ è½½äº†ä¸€æ¬¡ç»„ä»¶ Homeï¼Œå› ä¸ºæ˜¯å®¢æˆ·ç«¯æ¸²æŸ“çš„ Homeï¼Œæ²¡æœ‰ç”¨åˆ° renderToSringï¼ŒJS äº‹ä»¶ä¹Ÿéƒ½å¯ä»¥æ­£å¸¸ç»‘å®šä¸Šå»äº†ã€‚</p></blockquote> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token comment">// src/client/index.js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDom <span class="token keyword">from</span> <span class="token string">&quot;react-dom&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> Home <span class="token keyword">from</span> <span class="token string">&quot;../containers/Home&quot;</span><span class="token punctuation">;</span>

ReactDom<span class="token punctuation">.</span><span class="token function">hydrate</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Home</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>è¿™é‡Œè¦æ³¨æ„ï¼ŒåŒæ„çš„ä½¿ç”¨ ReactDom.hydrate <code>ReactDom.hydrate(&lt;Home /&gt;, document.getElementById(&quot;root&quot;));</code></p> <p>è€Œä¸æ˜¯<code>ReactDom.render(&lt;Home /&gt;, document.getElementById(&quot;root&quot;));</code></p> <p>è¿™æ—¶å€™æœåŠ¡å™¨æ¸²æŸ“å‡ºçš„å†…å®¹é‡Œï¼Œbutton ä¸Šä¾ç„¶æ˜¯æ²¡æœ‰ js è¯­å¥çš„ï¼Œä½†å› ä¸ºæ˜¯å®¢æˆ·ç«¯æ¸²æŸ“æ—¶åŠ è½½çš„ index.js æ–‡ä»¶ï¼Œä½¿å¾— button ä¸Šçš„ click è¯­å¥æ­£å¸¸æ‰§è¡Œäº†ã€‚
<img src="/n-book/assets/img/source_2.e9298d41.png" alt="source_2"></p> <p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æµè§ˆå™¨è¯·æ±‚çš„å…ˆæ˜¯æœåŠ¡å™¨ç«¯è¿”å›çš„ localhost htmlï¼Œç„¶åå†è¯·æ±‚åŠ è½½çš„ index.jsï¼š
<img src="/n-book/assets/img/network_1.0edeb994.png" alt="network_1"></p> <h2 id="åœ¨-ssr-æ¡†æ¶ä¸­å¼•å…¥è·¯ç”±æœºåˆ¶"><a href="#åœ¨-ssr-æ¡†æ¶ä¸­å¼•å…¥è·¯ç”±æœºåˆ¶" class="header-anchor">#</a> åœ¨ SSR æ¡†æ¶ä¸­å¼•å…¥è·¯ç”±æœºåˆ¶</h2> <p>å®¢æˆ·ç«¯çš„è·¯ç”±æœºåˆ¶ï¼š
<img src="/n-book/assets/img/flow_4.fb2357a3.png" alt="flow_4"></p> <p>æœåŠ¡å™¨ç«¯è·¯ç”±æœºåˆ¶ï¼š
åœ¨å®¢æˆ·ç«¯çš„è·¯ç”±æœºåˆ¶æ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯åœ¨æœåŠ¡å™¨ç«¯å°±ä¸ä¸€æ ·äº†ã€‚</p> <p>æœ€å¤§çš„åŒºåˆ«æ˜¯æœåŠ¡å™¨ç«¯ä½¿ç”¨ <strong>StaticRouter</strong> ï¼Œè€Œå®¢æˆ·ç«¯ä½¿ç”¨ <strong>BrowserRouter</strong>ã€‚</p> <p>æ–‡æ¡£ï¼š<a href="https://reacttraining.com/react-router/web/api/StaticRouter" target="_blank" rel="noopener noreferrer">https://reacttraining.com/react-router/web/api/StaticRouter<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>å®‰è£… react è·¯ç”±ï¼š</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">yarn</span> <span class="token function">add</span> react-router-dom
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="è·¯ç”±é…ç½®æ–‡ä»¶ï¼š"><a href="#è·¯ç”±é…ç½®æ–‡ä»¶ï¼š" class="header-anchor">#</a> è·¯ç”±é…ç½®æ–‡ä»¶ï¼š</h3> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token comment">// src/Routes.js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Route <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Home <span class="token keyword">from</span> <span class="token string">&quot;./containers/Home&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Login <span class="token keyword">from</span> <span class="token string">&quot;./containers/Login&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/<span class="token punctuation">&quot;</span></span> <span class="token attr-name">exact</span> <span class="token attr-name">component</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Home<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/login<span class="token punctuation">&quot;</span></span> <span class="token attr-name">exact</span> <span class="token attr-name">component</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Login<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="å®¢æˆ·ç«¯ä½¿ç”¨-browserrouter-è¿›è¡Œå®¢æˆ·ç«¯è·¯ç”±æ¸²æŸ“ï¼š"><a href="#å®¢æˆ·ç«¯ä½¿ç”¨-browserrouter-è¿›è¡Œå®¢æˆ·ç«¯è·¯ç”±æ¸²æŸ“ï¼š" class="header-anchor">#</a> å®¢æˆ·ç«¯ä½¿ç”¨ BrowserRouter è¿›è¡Œå®¢æˆ·ç«¯è·¯ç”±æ¸²æŸ“ï¼š</h3> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// /src/client/index.js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDom <span class="token keyword">from</span> <span class="token string">&quot;react-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Routes <span class="token keyword">from</span> <span class="token string">&quot;../Routes&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">BrowserRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>Routes<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">BrowserRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

ReactDom<span class="token punctuation">.</span><span class="token function">hydrate</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="æœåŠ¡ç«¯çš„è·¯ç”±å†™æ³•ï¼š"><a href="#æœåŠ¡ç«¯çš„è·¯ç”±å†™æ³•ï¼š" class="header-anchor">#</a> æœåŠ¡ç«¯çš„è·¯ç”±å†™æ³•ï¼š</h3> <p>è€ŒæœåŠ¡å™¨ç«¯ç”± express ç›‘å¬æ‰€æœ‰è·¯ç”±è·¯å¾„ï¼Œå¹¶ä¸”æŠŠè¦æ¸²æŸ“çš„å†…å®¹å°è£…æˆä¸€ä¸ª render æ–¹æ³•ï¼ˆä¼˜åŒ–ç­–ç•¥ï¼‰ï¼š</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/server/index.js</span>
<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">&quot;express&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./utils&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">&quot;public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// * è¡¨ç¤ºexpress ç›‘å¬æ‰€æœ‰çš„è·¯ç”±è·¯å¾„</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> server <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>req æ˜¯ express ç›‘å¬åˆ°è·¯ç”±å˜æ›´æ—¶çš„ä¸€ä¸ªå¤§å¯¹è±¡ï¼Œå…¶ä¸­ req.path æ˜¯å½“å‰ url çš„ pathnameã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/server/utils.js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> renderToString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-dom/server&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> StaticRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Routes <span class="token keyword">from</span> <span class="token string">&quot;../Routes&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token parameter">req</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span>
    <span class="token comment">// æœåŠ¡å™¨ç«¯ StaticRouter æ— æ³•ç›‘å¬åˆ°å®¢æˆ·ç«¯çš„urlè·¯å¾„ï¼Œæ‰€ä»¥éœ€è¦req.pathä¼ ç»™locationï¼Œä»¥ä¾¿çŸ¥é“å½“å‰çš„path</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">StaticRouter</span></span> <span class="token attr-name">location</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>req<span class="token punctuation">.</span>path<span class="token punctuation">}</span></span> <span class="token attr-name">context</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>Routes<span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">StaticRouter</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;html&gt;
      &lt;head&gt;
        &lt;title&gt;ssr&lt;/title&gt;
      &lt;/head&gt;
      &lt;body&gt;
        &lt;div id=&quot;root&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div&gt;
        &lt;script src='/index.js'&gt;&lt;/script&gt;
      &lt;/body&gt;
    &lt;/html&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>render æ–¹æ³•ä¸­ä½¿ç”¨ StaticRouter è¿›è¡ŒæœåŠ¡å™¨ç«¯è·¯ç”±æ¸²æŸ“ã€‚</p> <p>context ä¼ é€’ä¸€ä¸ªå¯¹è±¡æ¥é€šä¿¡ã€‚å®˜æ–¹è§£é‡Šï¼šA plain JavaScript object. During the render, components can add properties to the object to store information about the render. When a <code>&lt;Route&gt;</code>Â matches, it will pass the context object to the component it renders as theÂ staticContextÂ prop.</p> <h3 id="ä½¿ç”¨linkæ ‡ç­¾ä¸²èµ·è·¯ç”±"><a href="#ä½¿ç”¨linkæ ‡ç­¾ä¸²èµ·è·¯ç”±" class="header-anchor">#</a> ä½¿ç”¨Linkæ ‡ç­¾ä¸²èµ·è·¯ç”±</h3> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token comment">// src/components/Header.js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Link <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">Header</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span></span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Home</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Link</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span></span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/login<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Login</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Link</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> Header<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>å¼•å…¥ç»„ä»¶ç‚¹å‡»å³å¯è·³è½¬è·¯ç”±ã€‚</p> <p><strong>æœåŠ¡å™¨ç«¯æ¸²æŸ“åªå‘ç”Ÿåœ¨æˆ‘ä»¬ç¬¬ä¸€æ¬¡è¿›å…¥é¡µé¢çš„æ—¶å€™ï¼Œä¹‹åé¡µé¢ç”± React ä»£ç æ¥ç®¡ï¼Œè·¯ç”±è·³è½¬éƒ½æ˜¯å®¢æˆ·ç«¯æ§åˆ¶çš„ï¼Œä¸ä¼šé‡æ–°è¯·æ±‚é¡µé¢ã€‚</strong></p> <h2 id="ssr-æ¡†æ¶ä¸-redux-çš„ç»“åˆ"><a href="#ssr-æ¡†æ¶ä¸-redux-çš„ç»“åˆ" class="header-anchor">#</a> SSR æ¡†æ¶ä¸ Redux çš„ç»“åˆ</h2> <h3 id="åŒæ„é¡¹ç›®ä¸­å¼•å…¥-redux"><a href="#åŒæ„é¡¹ç›®ä¸­å¼•å…¥-redux" class="header-anchor">#</a> åŒæ„é¡¹ç›®ä¸­å¼•å…¥ Redux</h3> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token comment">// src/store/index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createStore<span class="token punctuation">,</span> applyMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;redux&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> thunk <span class="token keyword">from</span> <span class="token string">&quot;redux-thunk&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> defaultStore <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">&quot;Du&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> defaultStore<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> state<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">getStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>thunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> getStore<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>Q: ä¸ºä»€ä¹ˆ store è¿”å›æ˜¯ä»¥ä¸€ä¸ª getStore() å‡½æ•°çš„æ–¹å¼ï¼Ÿ</p> <p>A: æ¶‰åŠåˆ°<strong>å•ä¾‹</strong>çš„é—®é¢˜ï¼Œåœ¨æœåŠ¡å™¨ç«¯ç›´æ¥è¿”å›ä¸€ä¸ª store å¯¹è±¡çš„è¯ï¼Œé‚£ä¼—å¤šæµè§ˆå™¨åœ¨è®¿é—®çš„æ—¶å€™ï¼Œéƒ½æ˜¯è¯»å–çš„è¿™ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹æœåŠ¡å™¨å‹åŠ›ä¼šå¾ˆå¤§ã€‚è€Œè¿”å›ä¸€ä¸ªå‡½æ•°çš„æ–¹å¼ï¼Œä½¿å¾— store å¯¹è±¡æ˜¯åœ¨å®¢æˆ·ç«¯ç”Ÿæˆï¼Œå³å¤šä¾‹çš„è¿ç”¨ã€‚</p> <p>å®¢æˆ·ç«¯å¼•å…¥</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/client/index.js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDom <span class="token keyword">from</span> <span class="token string">&quot;react-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Provider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-redux&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> getStore <span class="token keyword">from</span> <span class="token string">&quot;../store&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Routes <span class="token keyword">from</span> <span class="token string">&quot;../Routes&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Provider</span></span> <span class="token attr-name">store</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">BrowserRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>Routes<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">BrowserRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Provider</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

ReactDom<span class="token punctuation">.</span><span class="token function">hydrate</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>æœåŠ¡å™¨ç«¯å¼•å…¥</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/server/utils.js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> renderToString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-dom/server&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> StaticRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Routes <span class="token keyword">from</span> <span class="token string">&quot;../Routes&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Provider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-redux&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> getStore <span class="token keyword">from</span> <span class="token string">&quot;../store&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token parameter">req</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Provider</span></span> <span class="token attr-name">store</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">StaticRouter</span></span> <span class="token attr-name">location</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>req<span class="token punctuation">.</span>path<span class="token punctuation">}</span></span> <span class="token attr-name">context</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span>Routes<span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">StaticRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Provider</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;html&gt;
      &lt;head&gt;
        &lt;title&gt;ssr&lt;/title&gt;
      &lt;/head&gt;
      &lt;body&gt;
        &lt;div id=&quot;root&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div&gt;
        &lt;script src='/index.js'&gt;&lt;/script&gt;
      &lt;/body&gt;
    &lt;/html&gt;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="æ„å»º-redux-ä»£ç ç»“æ„"><a href="#æ„å»º-redux-ä»£ç ç»“æ„" class="header-anchor">#</a> æ„å»º Redux ä»£ç ç»“æ„</h3> <p>çœç•¥... ä¼˜åŒ– redux çš„å·¥ç¨‹ç›®å½•ã€‚</p> <p><strong>æµç¨‹å›é¡¾ï¼š</strong></p> <ol><li><p>æœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚ï¼Œè¿™ä¸ªæ—¶å€™ store æ˜¯ç©ºçš„</p></li> <li><p>æœåŠ¡å™¨ç«¯ä¸ä¼šæ‰§è¡Œ componentDidMountï¼Œæ‰€ä»¥åˆ—è¡¨å†…å®¹è·å–ä¸åˆ°</p></li> <li><p>å®¢æˆ·ç«¯ä»£ç è¿è¡Œï¼Œè¿™ä¸ªæ—¶å€™ store ä¾ç„¶æ˜¯ç©ºçš„</p></li> <li><p>å®¢æˆ·ç«¯æ‰§è¡Œ componentDidMountï¼Œåˆ—è¡¨æ•°æ®è¢«è·å–</p></li> <li><p>store ä¸­çš„åˆ—è¡¨æ•°æ®è¢«æ›´æ–°</p></li> <li><p>å®¢æˆ·ç«¯æ¸²æŸ“å‡º store ä¸­ list æ•°æ®å¯¹åº”çš„åˆ—è¡¨å†…å®¹</p></li></ol> <p><strong>componentDidMount åªä¼šåœ¨å®¢æˆ·ç«¯ä¸Šæ‰§è¡Œï¼Œåœ¨æœåŠ¡ç«¯ä¸Šä¸ä¼šæ‰§è¡Œ</strong>ã€‚æ‰€ä»¥é¡µé¢çš„åˆ—è¡¨å†…å®¹éƒ½æ˜¯å®¢æˆ·ç«¯æ¸²æŸ“å‡ºæ¥çš„ã€‚</p> <p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦è®©æœåŠ¡å™¨ç«¯ä¹Ÿèƒ½é¢„å…ˆæ‰§è¡Œå»è·å–æ•°æ®ï¼Œè¿›è¡ŒæœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼Œç›´æ¥æŠŠè·å–åˆ°æ•°æ®çš„é¡µé¢è¿”å›æ¥ã€‚</p> <h3 id="å¼‚æ­¥æ•°æ®æœåŠ¡å™¨æ¸²æŸ“ï¼šloaddata-æ–¹æ³•åŠè·¯ç”±é‡æ„"><a href="#å¼‚æ­¥æ•°æ®æœåŠ¡å™¨æ¸²æŸ“ï¼šloaddata-æ–¹æ³•åŠè·¯ç”±é‡æ„" class="header-anchor">#</a> å¼‚æ­¥æ•°æ®æœåŠ¡å™¨æ¸²æŸ“ï¼šloadData æ–¹æ³•åŠè·¯ç”±é‡æ„</h3> <p>æ–‡æ¡£ï¼š<a href="https://reacttraining.com/react-router/web/guides/server-rendering" target="_blank" rel="noopener noreferrer">https://reacttraining.com/react-router/web/guides/server-rendering<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><div class="highlighted">Â </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/server/utils.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">import</span> getStore <span class="token keyword">from</span> <span class="token string">'../store'</span><span class="token punctuation">;</span>

<span class="token comment">// æœåŠ¡å™¨ç«¯ï¼šåœ¨è¿™é‡Œæ‹¿åˆ°å¼‚æ­¥çš„æ•°æ®å¹¶å¡«å……åˆ°storeï¼Œå°±å¯ä»¥åœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶æœ‰æ•°æ®ç›´æ¥æ¸²æŸ“</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">getStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Provider</span></span> <span class="token attr-name">store</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">StaticRouter</span></span> <span class="token attr-name">location</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>req<span class="token punctuation">.</span>path<span class="token punctuation">}</span></span> <span class="token attr-name">context</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span>Routes<span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">StaticRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Provider</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;html&gt;
      &lt;head&gt;
        &lt;title&gt;ssr&lt;/title&gt;
      &lt;/head&gt;
      &lt;body&gt;
        &lt;div id=&quot;root&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div&gt;
        &lt;script src='/index.js'&gt;&lt;/script&gt;
      &lt;/body&gt;
    &lt;/html&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>æƒ³å®ç°æœåŠ¡ç«¯æ¸²æŸ“å¼‚æ­¥æ•°æ®ï¼Œé‚£éœ€è¦åœ¨æœåŠ¡ç«¯æ¸²æŸ“å‰æ‹¿åˆ°å¼‚æ­¥æ•°æ®ã€‚</p> <p>store é‡Œå¡«å……çš„æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬éœ€è¦ç»“åˆå½“å‰ç”¨æˆ·è¯·æ±‚çš„åœ°å€+è·¯ç”±æ¥åšåˆ¤æ–­ã€‚</p> <p>å¦‚æœç”¨æˆ·è®¿é—® / è·¯å¾„ï¼Œæˆ‘ä»¬å°±æ‹¿ / è·¯å¾„å¯¹åº”çš„ Home ç»„ä»¶çš„å¼‚æ­¥æ•°æ®ç»™ storeã€‚</p> <p>å¦‚æœç”¨æˆ·è®¿é—® /login è·¯å¾„ï¼Œæˆ‘ä»¬å°±æ‹¿ /login è·¯å¾„å¯¹åº”çš„ Loging ç»„ä»¶çš„å¼‚æ­¥æ•°æ®ç»™ storeã€‚</p> <p><strong>ç¬¬ä¸€æ­¥ï¼Œåœ¨æœåŠ¡ç«¯æ¸²æŸ“å‰ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è·¯ç”±çš„ä¸åŒæ¥è·å–è¯¥è·¯ç”±æ‰€å¯¹åº”ç»„ä»¶çš„å¼‚æ­¥æ•°æ®ï¼Œä¾‹å¦‚ Home ç»„ä»¶ï¼ŒloadData æ–¹æ³•ç”¨äºè·å–è¯¥ç»„ä»¶ç›¸å…³çš„æ•°æ®ã€‚</strong></p> <p><strong>ç¬¬äºŒæ­¥ï¼Œè·å–åˆ°ç»„ä»¶ç›¸å…³æ•°æ®åï¼Œå¡«å……åˆ° store ä¸­ï¼Œç„¶åè¿›è¡ŒæœåŠ¡å™¨ç«¯æ¸²æŸ“ã€‚</strong></p> <p>æˆ‘ä»¬å…ˆæ¥åšç¬¬ä¸€æ­¥çš„å†…å®¹ã€‚</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token comment">// src/containers/Home/index.js</span>
<span class="token keyword">class</span> <span class="token class-name">Home</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
Home<span class="token punctuation">.</span><span class="token function-variable function">loadData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¿™ä¸ªå‡½æ•°ï¼Œè´Ÿè´£åœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“ä¹‹å‰ï¼ŒæŠŠè¿™ä¸ªè·¯ç”±éœ€è¦çš„æ•°æ®æå‰åŠ è½½å¥½</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>ä¸ºäº†å®ç° æ ¹æ®è·¯ç”±çš„ä¸åŒæ¥è·å–è¯¥è·¯ç”±æ‰€å¯¹åº”ç»„ä»¶çš„å¼‚æ­¥æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦æ”¹é€ è·¯ç”±çš„å†™æ³•ã€‚</p> <p>åŸæ¥çš„ server/src/Routes.js</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/<span class="token punctuation">&quot;</span></span> <span class="token attr-name">exact</span> <span class="token attr-name">component</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Home<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/login<span class="token punctuation">&quot;</span></span> <span class="token attr-name">exact</span> <span class="token attr-name">component</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Login<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>react-router æä¾›äº†æœåŠ¡å™¨ç«¯æ¸²æŸ“æ‰€éœ€æ–¹æ³•ï¼Œè¿™æ—¶å€™Routes.jséœ€è¦è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œé‡Œé¢çš„ä¸€ä¸ªä¸ªå¯¹è±¡å¯¹åº”ç€ä¸€ä¸ªä¸ªè·¯ç”±ã€‚</p> <p>æ”¹å†™åçš„ server/src/Routes.js</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token comment">// å½“æˆ‘åŠ è½½æ˜¾ç¤ºHOMEç»„ä»¶ä¹‹å‰ï¼Œæˆ‘å¸Œæœ›è°ƒç”¨Home.loadDataæ–¹æ³•ï¼Œæå‰è·å–åˆ°å¿…è¦çš„å¼‚æ­¥æ•°æ®</span>
<span class="token comment">// ç„¶åå†åšæœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼ŒæŠŠé¡µé¢è¿”å›ç»™ç”¨æˆ·</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token punctuation">:</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
    component<span class="token punctuation">:</span> Home<span class="token punctuation">,</span>
    exact<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// åŠ è½½ Home ä¹‹å‰è¦æ‰§è¡Œçš„æ–¹æ³•</span>
    loadData<span class="token punctuation">:</span> Home<span class="token punctuation">.</span>loadData<span class="token punctuation">,</span>
    key<span class="token punctuation">:</span> <span class="token string">&quot;home&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    path<span class="token punctuation">:</span> <span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span>
    component<span class="token punctuation">:</span> Login<span class="token punctuation">,</span>
    exact<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    key<span class="token punctuation">:</span> <span class="token string">&quot;login&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>å½“åŠ è½½æ˜¾ç¤º HOME ç»„ä»¶ä¹‹å‰ï¼Œæˆ‘ä»¬å¸Œæœ›è°ƒç”¨ Home.loadData æ–¹æ³•ï¼Œæå‰è·å–åˆ°å¿…è¦çš„å¼‚æ­¥æ•°æ®ã€‚ç„¶åå†åšæœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼ŒæŠŠé¡µé¢è¿”å›ç»™ç”¨æˆ·ã€‚</p> <p>ä¸ä¹‹å¯¹åº”çš„è¿˜è¦å»ä¿®æ”¹å¼•ç”¨äº†è·¯ç”±çš„åœ°æ–¹(å› ä¸ºåŸæ¥è¿”å› Route å¯¹è±¡ï¼Œç°åœ¨åªè¿”å›äº†ä¸€ä¸ªæ•°ç»„)ã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/client/index.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">import</span> routes <span class="token keyword">from</span> <span class="token string">&quot;../Routes&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Provider</span></span> <span class="token attr-name">store</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">BrowserRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
          </span><span class="token punctuation">{</span><span class="token comment">/*éå†ç”Ÿæˆæ–°çš„Routeç»„ä»¶*/</span><span class="token punctuation">}</span><span class="token plain-text">
          </span><span class="token punctuation">{</span>routes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">route</span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span>
          <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">BrowserRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Provider</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>server/src/server/utils.js åŒç†ã€‚</strong></p> <p>ç„¶åæˆ‘ä»¬å»ä¿®æ”¹æœåŠ¡å™¨ç«¯æ¸²æŸ“å‰çš„æ–‡ä»¶ï¼Œä½¿å…¶èƒ½è·å–åˆ°ç”¨æˆ·å½“å‰è®¿é—®çš„åœ°å€+è·¯ç”±ã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/server/utils.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> StaticRouter<span class="token punctuation">,</span> Route<span class="token punctuation">,</span> matchPath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> routes <span class="token keyword">from</span> <span class="token string">&quot;../Routes&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> getStore <span class="token keyword">from</span> <span class="token string">&quot;../store&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token parameter">req</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// æœåŠ¡å™¨ç«¯ï¼šåœ¨è¿™é‡Œæ‹¿åˆ°å¼‚æ­¥çš„æ•°æ®å¹¶å¡«å……åˆ°storeï¼Œå°±å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“æ—¶æœ‰æ•°æ®ä¸€å—æ¸²æŸ“</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">getStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// æ ¹æ®è·¯ç”±çš„è·¯å¾„ï¼Œæ¥å¾€storeé‡Œé¢åŠ æ•°æ®</span>
  <span class="token keyword">const</span> matchRoutes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// use 'some' to imitate '&lt;Switch&gt;' behavior of selecting only</span>
  routes<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// matchPath: å½“å‰è·¯å¾„req.pathå’Œrouteå¯¹è±¡æ˜¯å¦åŒ¹é…ï¼ŒåŒ¹é…è¿”å›true</span>
    <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token function">matchPath</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>path<span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      matchRoutes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>react router æä¾›äº† matchPath æ–¹æ³•ï¼Œå¯ä»¥å°†å½“å‰è·¯å¾„å’Œ route å¯¹è±¡è¿›è¡ŒåŒ¹é…ï¼ŒåŒ¹é…ä¸Šåˆ™è¿”å› trueã€‚</p> <p>TheÂ <strong>some()</strong>Â method tests whether at least oneÂ element in the array passes the test implemented by the provided function.</p> <p>å‡å¦‚æˆ‘ä»¬è®¿é—®çš„æ˜¯æ ¹è·¯å¾„ï¼Œæ‰“å°è¾“å‡º matchRoutes æ•°ç»„ï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªåŒ¹é…ä¸Šçš„ route å¯¹è±¡ï¼š
<img src="/n-book/assets/img/console_1.1ddff788.png" alt="console_1"></p> <p>è¿™æ ·ä¾¿å¯ä»¥çŸ¥é“ç”¨æˆ·è®¿é—®çš„æ˜¯å“ªä¸ªè·¯ç”±ç»„ä»¶ï¼Œ<strong>ä»è€Œå¯ä»¥æ‰§è¡Œå®ƒçš„ loadData æ–¹æ³•ï¼ŒåŠ è½½æ•°æ®ã€‚</strong></p> <h3 id="å¤šçº§è·¯ç”±é—®é¢˜çš„å¤„ç†"><a href="#å¤šçº§è·¯ç”±é—®é¢˜çš„å¤„ç†" class="header-anchor">#</a> å¤šçº§è·¯ç”±é—®é¢˜çš„å¤„ç†</h3> <p>matchPath æœ‰ä¸ªç¼ºé™·ï¼Œä¸èƒ½æ•è·å¤šçº§è·¯ç”±ã€‚</p> <p>è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥å€ŸåŠ© react-router-config è¿™ä¸ªåº“çš„ matchRoutes æ–¹æ³•æ¥ä»£æ›¿ã€‚</p> <p>æ–‡æ¡£ï¼š<a href="https://github.com/ReactTraining/react-router/tree/master/packages/react-router-config" target="_blank" rel="noopener noreferrer">https://github.com/ReactTraining/react-router/tree/master/packages/react-router-config<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>å‡è®¾æˆ‘ä»¬åœ¨ <code>/</code> ä¸‹æ–°å¢ä¸€ä¸ªå­è·¯ç”± <code>/subHome</code>ï¼š</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token punctuation">{</span>
  path<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    component<span class="token punctuation">:</span> Home<span class="token punctuation">,</span>
    loadData<span class="token punctuation">:</span> Home<span class="token punctuation">.</span>loadData<span class="token punctuation">,</span>
    key<span class="token punctuation">:</span> <span class="token string">'home'</span><span class="token punctuation">,</span>
    routes<span class="token punctuation">:</span><span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span> <span class="token string">'/subHome'</span><span class="token punctuation">,</span>
          component<span class="token punctuation">:</span> Login<span class="token punctuation">,</span>
          exact<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          key<span class="token punctuation">:</span> <span class="token string">'subHome'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>æˆ‘ä»¬ä½¿ç”¨ matchRoutes ä»£æ›¿ matchPathï¼Œä¹‹å‰çš„å†™æ³•å¯ä»¥ç®€åŒ–ã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/server/utils.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> matchRoutes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-config'</span>
<span class="token keyword">import</span> routes <span class="token keyword">from</span> <span class="token string">'../Routes'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> getStore <span class="token keyword">from</span> <span class="token string">'../store'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token comment">// æœåŠ¡å™¨ç«¯ï¼šåœ¨è¿™é‡Œæ‹¿åˆ°å¼‚æ­¥çš„æ•°æ®å¹¶å¡«å……åˆ°storeï¼Œå°±å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“æ—¶æœ‰æ•°æ®ä¸€å—æ¸²æŸ“</span>
	<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">getStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// æ ¹æ®è·¯ç”±çš„è·¯å¾„ï¼Œæ¥å¾€storeé‡Œé¢åŠ æ•°æ®</span>
	<span class="token keyword">const</span> matchedRoutes <span class="token operator">=</span> <span class="token function">matchRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> req<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>è®¿é—®/subHome è·¯å¾„ï¼Œæ‰“å°è¾“å‡º matchdRoutesï¼Œå¯ä»¥çœ‹åˆ° å­ route å¯¹è±¡ä¹Ÿæ˜¾ç¤ºå‡ºæ¥äº†ã€‚
<img src="/n-book/assets/img/console_2.56e149a6.png" alt="console_2"></p> <p>ä¸‹é¢æˆ‘ä»¬æ¥æ ¹æ®ç”¨æˆ·è®¿é—®çš„è·¯ç”±ç»„ä»¶ï¼Œæ‰§è¡Œå®ƒçš„ loadData æ–¹æ³•ï¼ŒåŠ è½½æ•°æ®ã€‚</p> <h3 id="æœåŠ¡å™¨ç«¯è·å–å¼‚æ­¥æ•°æ®ï¼Œæ¸²æŸ“åè¿”å›ç»™æµè§ˆå™¨"><a href="#æœåŠ¡å™¨ç«¯è·å–å¼‚æ­¥æ•°æ®ï¼Œæ¸²æŸ“åè¿”å›ç»™æµè§ˆå™¨" class="header-anchor">#</a> æœåŠ¡å™¨ç«¯è·å–å¼‚æ­¥æ•°æ®ï¼Œæ¸²æŸ“åè¿”å›ç»™æµè§ˆå™¨</h3> <p>éå† matchedRoutes æ•°ç»„ï¼Œå¯ä»¥çœ‹åˆ°é‡Œé¢å„ä¸ªè·¯å¾„å¯¹åº”çš„è·¯ç”±ä¿¡æ¯ï¼Œå‡å¦‚ matchedRoutes æ•°ç»„çš„å…¶ä¸­çš„æ•°æ®é¡¹é‡Œæœ‰ loadData æ–¹æ³•ï¼Œè¯´æ˜æ˜¯éœ€è¦é¢„åŠ è½½æ•°æ®çš„ç»„ä»¶ã€‚æ‰€ä»¥æ‰§è¡Œå®ƒçš„ loadData æ–¹æ³•ï¼ŒæŠŠæ•°æ®å¼‚æ­¥åŠ è½½è¿”å›ï¼Œå¡åˆ° promises æ•°ç»„é‡Œã€‚ç­‰åˆ°æ‰€æœ‰çš„å¼‚æ­¥æ•°æ®éƒ½åŠ è½½å¥½åï¼Œå† res.send è¿”å› render å‡½æ•°ä¸­æ¸²æŸ“çš„æ‰€æœ‰å†…å®¹ç»™æµè§ˆå™¨ã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/server/index.js</span>
<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">&quot;express&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> matchRoutes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-config&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./utils&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> getStore <span class="token keyword">from</span> <span class="token string">&quot;../store&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> routes <span class="token keyword">from</span> <span class="token string">&quot;../Routes&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">&quot;public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// æœåŠ¡å™¨ç«¯ï¼šåœ¨è¿™é‡Œæ‹¿åˆ°å¼‚æ­¥çš„æ•°æ®å¹¶å¡«å……åˆ°storeï¼Œå°±å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“æ—¶æœ‰æ•°æ®ä¸€å—æ¸²æŸ“</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">getStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// æ ¹æ®è·¯ç”±çš„è·¯å¾„ï¼Œæ¥å¾€storeé‡Œé¢åŠ æ•°æ®</span>
  <span class="token keyword">const</span> matchedRoutes <span class="token operator">=</span> <span class="token function">matchRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> req<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ç”¨äºç®¡ç†å¤šä¸ªpromise è¯·æ±‚çš„æ‰§è¡Œç»“æœ</span>
  <span class="token keyword">const</span> promises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  matchedRoutes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// è®©matchRoutesé‡Œé¢æ‰€æœ‰çš„ç»„ä»¶ï¼Œå¯¹åº”çš„loadDataæ–¹æ³•æ‰§è¡Œä¸€æ¬¡</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>route<span class="token punctuation">.</span>loadData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// item.route.loadData() ç”¨äºè·å–å¼‚æ­¥æ•°æ®</span>
      promises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>route<span class="token punctuation">.</span><span class="token function">loadData</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ‰€æœ‰å¼‚æ­¥æ•°æ®éƒ½è·å–åˆ°åï¼Œå†æœåŠ¡ç«¯æ¸²æŸ“é¡µé¢</span>
  Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> routes<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> server <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token comment">// src/server/utils.js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> renderToString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-dom/server&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> StaticRouter<span class="token punctuation">,</span> Route <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Provider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-redux&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> routes<span class="token punctuation">,</span> req</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Provider</span></span> <span class="token attr-name">store</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">StaticRouter</span></span> <span class="token attr-name">location</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>req<span class="token punctuation">.</span>path<span class="token punctuation">}</span></span> <span class="token attr-name">context</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
          </span><span class="token punctuation">{</span>routes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">route</span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span>
          <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">StaticRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Provider</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
	&lt;html&gt;
		&lt;head&gt;
			&lt;title&gt;ssr&lt;/title&gt;
		&lt;/head&gt;
		&lt;body&gt;
			&lt;div id=&quot;root&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div&gt;
			&lt;script src='/index.js'&gt;&lt;/script&gt;
		&lt;/body&gt;
	&lt;/html&gt;
	</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>æ‰§è¡Œç»„ä»¶å¯¹åº”çš„ loadData æ–¹æ³•ï¼ŒæŠŠæ•°æ®å¼‚æ­¥åŠ è½½è¿”å›ã€‚è¿™é‡Œæ¶‰åŠåˆ°æ¯”è¾ƒæ·±å…¥çš„ Promise æ‰§è¡Œè¿‡ç¨‹ã€‚å¯ä»¥çœ‹ä»£ç è¿›è¡Œç†è§£ã€‚ä¾‹å¦‚ä¸‹é¢çš„</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/containers/Home/store/actions.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getHomeList</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token parameter">dispatch</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// return ä¸€ä¸ªPromise å¯¹è±¡ï¼Œä¸€çº§çº§å¾€ä¸Šä¼ </span>
    <span class="token keyword">return</span> axios
      <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;http://47.95.113.63/ssr/api/news.json?secret=abcd&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> list <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
        <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">changeList</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/containers/Home/index.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> connect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-redux&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getHomeList <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./store/actions&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Home</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿™é‡Œåªæœ‰åœ¨å®¢æˆ·ç«¯æ¸²æŸ“æ‰æ‰§è¡Œ</span>
    <span class="token comment">// ä»mapDispatchToPropsé‡Œæ¥çš„getHomeList()</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">getHomeList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Home<span class="token punctuation">.</span><span class="token function-variable function">loadData</span> <span class="token operator">=</span> <span class="token parameter">store</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¿™ä¸ªå‡½æ•°ï¼Œè´Ÿè´£åœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“ä¹‹å‰ï¼ŒæŠŠè¿™ä¸ªè·¯ç”±éœ€è¦çš„æ•°æ®æå‰åŠ è½½å¥½</span>
  <span class="token comment">// ä¼ ä¸€ä¸ªstoreå€¼ç»™å®ƒæ˜¯ä¸ºäº†ä½¿ä¹‹å¯ä»¥dispatch</span>
  <span class="token comment">// store.dispatchè¿™ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯ä¸­é—´ä»¶å¤„ç†ï¼Œåˆ°actionsçš„getHomeList()æ–¹æ³•é‡Œå…·ä½“å¤„ç†å®ƒçš„æ´¾å‘å†…å®¹</span>
  <span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">getHomeList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">mapStateToProps</span> <span class="token operator">=</span> <span class="token parameter">state</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">mapDispatchToProps</span> <span class="token operator">=</span> <span class="token parameter">dispatch</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// è¿™é‡Œæ˜¯ç»™å®¢æˆ·ç«¯æ¸²æŸ“æ—¶ä½¿ç”¨</span>
  <span class="token function">getHomeList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">getHomeList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">connect</span><span class="token punctuation">(</span>
  mapStateToProps<span class="token punctuation">,</span>
  mapDispatchToProps
<span class="token punctuation">)</span><span class="token punctuation">(</span>Home<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>(å¤šæä¸€å¥ï¼Œåœ¨ Home.loadData é‡Œï¼Œå› ä¸ºå®ƒæ˜¯æœåŠ¡ç«¯æ¸²æŸ“æ—¶å»è°ƒç”¨ store.dispatch(getHomeList)ï¼Œå¤„ç†çš„æ˜¯æœåŠ¡ç«¯çš„ Storeï¼Œå¹¶ä¸åœ¨å®¢æˆ·ç«¯å¤„ç†ã€‚æ‰€ä»¥åœ¨ react-redux ä¸­çš„ connect æ–¹æ³•å¯¹åº”çš„ mapDispatchToProps æ˜¯ä¸éœ€è¦å£°æ˜å°±èƒ½ä½¿ç”¨ getHomeList æ–¹æ³•çš„)</p> <p>è¿™æ—¶å€™æœåŠ¡ç«¯è¿”å›çš„æ•°æ®é‡Œï¼Œå°±æœ‰äº†æ¸²æŸ“å¥½çš„æ•°æ®ã€‚
<img src="/n-book/assets/img/source_3.b0554baa.png" alt="source_3"></p> <h3 id="æ•°æ®çš„æ³¨æ°´å’Œè„±æ°´"><a href="#æ•°æ®çš„æ³¨æ°´å’Œè„±æ°´" class="header-anchor">#</a> æ•°æ®çš„æ³¨æ°´å’Œè„±æ°´</h3> <p>ä¸ºä»€ä¹ˆè¦æ³¨æ°´å’Œè„±æ°´ï¼Ÿ</p> <p>åœ¨è®¿é—®é¦–é¡µ <code>/</code> çš„æ—¶å€™ï¼Œæ”¾æ…¢ç½‘é€Ÿæˆ‘ä»¬ä¼šå‘ç°å…ˆç™½å±ï¼Œç„¶åæ‰å‡ºç°äº†å†…å®¹ã€‚</p> <p>åŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p> <p>å°½ç®¡æœåŠ¡ç«¯å·²ç»æŠŠé¦–é¡µçš„å†…å®¹éƒ½æ¸²æŸ“å¥½äº†æ‰è¿”å›ï¼Œä½†æ˜¯å› ä¸ºåœ¨å®¢æˆ·ç«¯ä¸­ï¼ŒHome ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•° componentDidMount ä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œäºæ˜¯å®ƒä¾¿ä¼šé‡æ–°æ‰§è¡Œæ–¹æ³•å‘åå°è¯·æ±‚æ•°æ®ï¼Œç„¶åé‡æ–°æ‰§è¡Œäº†ä¸€æ¬¡å®¢æˆ·ç«¯æ¸²æŸ“ï¼ŒæŠŠæ•°æ®å†…å®¹å¡«å……åˆ°é¡µé¢ä¸Šã€‚</p> <p>è¿™é€ æˆäº†ç½‘ç»œè¯·æ±‚çš„æµªè´¹ï¼ŒæŸè€—æ€§èƒ½ã€‚</p> <p>æ—¢ç„¶æˆ‘ä»¬å·²ç»åœ¨æœåŠ¡ç«¯å·²ç»è¯·æ±‚è¿‡äº†æ•°æ®ï¼Œé‚£åœ¨å®¢æˆ·ç«¯æ¸²æŸ“æ—¶ï¼Œå°±åº”è¯¥ç›´æ¥ä½¿ç”¨æœåŠ¡ç«¯è¯·æ±‚å¥½çš„æ•°æ®ï¼Œæ³¨å…¥åˆ°å®¢æˆ·ç«¯æ¸²æŸ“ä¸­çš„ stateã€‚è¿™ä¸ªå°±å«åš<strong>æ³¨æ°´</strong>ã€‚</p> <p>ä¾‹å¦‚ï¼Œåœ¨è¿”å›çš„é¡µé¢å†…å®¹ window.context ä¸‹ï¼Œæ³¨å…¥æœåŠ¡ç«¯è·å–åˆ°çš„ store çš„æ•°æ®å†…å®¹ï¼š</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/server/utils.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;html&gt;
    &lt;head&gt;
      &lt;title&gt;ssr&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
      &lt;div id=&quot;root&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div&gt;
      &lt;script&gt;
        window.context = {
          state: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
        }
      &lt;/script&gt;
      &lt;script src='/index.js'&gt;&lt;/script&gt;
    &lt;/body&gt;
  &lt;/html&gt;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>æœåŠ¡ç«¯è¿”å›çš„é¡µé¢é‡Œå¯è§ window.context ä¸‹çš„å†…å®¹ã€‚
<img src="/n-book/assets/img/source_4.d7331dc5.png" alt="source_4"></p> <p>åœ¨å®¢æˆ·ç«¯æ‹¿åˆ°æœåŠ¡ç«¯ç»™çš„æ•°æ®ç›´æ¥ä½¿ç”¨ï¼Œè€Œä¸é‡æ–°å»è¯·æ±‚æ•°æ®ï¼Œè¿™ä¸ªä½¿ç”¨æœåŠ¡ç«¯ç»™çš„æ•°æ®çš„è¿‡ç¨‹å°±æ˜¯<strong>è„±æ°´</strong>ã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/store/index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createStore<span class="token punctuation">,</span> applyMiddleware<span class="token punctuation">,</span> combineReducers <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;redux&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> thunk <span class="token keyword">from</span> <span class="token string">&quot;redux-thunk&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> reducer <span class="token keyword">as</span> homeReducer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../containers/Home/store&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> reducer <span class="token operator">=</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  home<span class="token punctuation">:</span> homeReducer
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// æœåŠ¡ç«¯æ¸²æŸ“æ—¶åˆ›å»º store çš„æ–¹æ³•</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>thunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// å®¢æˆ·ç«¯æ¸²æŸ“æ—¶åˆ›å»º store çš„æ–¹æ³•</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getClientStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> defaultState <span class="token operator">=</span> window<span class="token punctuation">.</span>context<span class="token punctuation">.</span>state<span class="token punctuation">;</span>
  <span class="token comment">// createStoreçš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯é»˜è®¤çš„åˆå§‹å€¼</span>
  <span class="token keyword">return</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> defaultState<span class="token punctuation">,</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>thunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>ç„¶ååœ¨å®¢æˆ·ç«¯æ¸²æŸ“è¿™è¾¹æ›´å˜è·å– store çš„æ–¹æ³•ï¼š</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><div class="highlighted">Â </div><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/client/index.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Provider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-redux&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getClientStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../store&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">getClientStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Provider</span></span> <span class="token attr-name">store</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">BrowserRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
// ...
</span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>ç„¶ååœ¨å®¢æˆ·ç«¯æ‰§è¡Œçš„æ˜¯ getClientStore æ–¹æ³•ï¼Œå› ä¸ºåœ¨å®¢æˆ·ç«¯æ¸²æŸ“çš„æ—¶å€™ï¼Œwindow.context.state å·²ç»æ˜¯æœ‰å†…å®¹çš„äº†ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å–åˆ°æœåŠ¡ç«¯æ³¨æ°´æ—¶æä¾›çš„æ•°æ®ã€‚æ”¾åˆ° createStore çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ã€‚</p> <p>è¿™æ ·å°±å¯ä»¥ä½¿å¾—å®¢æˆ·ç«¯ç›´æ¥ä½¿ç”¨æœåŠ¡ç«¯æ¸²æŸ“å¥½çš„æ•°æ®ã€‚</p> <h3 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="header-anchor">#</a> ä¼˜åŒ–</h3> <p>ä½†æ˜¯çœ‹ç½‘ç»œè¯·æ±‚ï¼Œå› ä¸º componentDidMount çš„å­˜åœ¨ï¼Œå“ªæ€•å®¢æˆ·ç«¯æ¸²æŸ“æ—¶ç›´æ¥ä½¿ç”¨æœåŠ¡ç«¯è¿”å›çš„æ•°æ®ï¼Œä¹Ÿä¼šå‘é€è¯·æ±‚ã€‚æ‰€ä»¥æˆ‘ä»¬è¦åˆ¤æ–­ï¼Œå‡å¦‚æœåŠ¡ç«¯å·²ç»è¿”å›æ•°æ®äº†ï¼Œå®¢æˆ·ç«¯å°±ä¸è¯·æ±‚æ•°æ®ã€‚
<img src="/n-book/assets/img/code_1.28170c0a.png" alt="code_1"></p> <p>æœ€åè¦é‡ç”³ä¸€æ¬¡çš„æ˜¯ï¼ŒæœåŠ¡ç«¯æ¸²æŸ“åªæ˜¯ç¬¬ä¸€æ¬¡è®¿é—®é¡µé¢æ—¶æ‰æœ‰ç”¨ï¼Œä¹‹åçš„é¡µé¢å°±å®Œå…¨äº¤ç»™äº†å®¢æˆ·ç«¯æ¸²æŸ“ã€‚æ‰€ä»¥ componentDidMount çš„å­˜åœ¨æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œå®ƒåœ¨æœåŠ¡ç«¯æ²¡æœ‰è¿”å›æ•°æ®çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯è‡ªå·±æœ‰èƒ½åŠ›å»è¯·æ±‚æ•°æ®ã€‚</p> <h2 id="ä½¿ç”¨-node-ä½œä¸ºæ•°æ®è·å–ä¸­é—´å±‚"><a href="#ä½¿ç”¨-node-ä½œä¸ºæ•°æ®è·å–ä¸­é—´å±‚" class="header-anchor">#</a> ä½¿ç”¨ Node ä½œä¸ºæ•°æ®è·å–ä¸­é—´å±‚</h2> <p><img src="/n-book/assets/img/node_1.155cf7d5.png" alt="node_1">
æ—¢ç„¶å¼•å…¥äº†ä¸­é—´å±‚ï¼Œé‚£å®¢æˆ·ç«¯å°±ä¸èƒ½ç›´æ¥å»å’Œåå°è¯·æ±‚æ•°æ®ï¼Œå¿…é¡»é€šè¿‡ Node å±‚ã€‚</p> <h3 id="ä½¿ç”¨-proxy-ä»£ç†ï¼Œè®©ä¸­é—´å±‚æ‰¿æ‹…æ•°æ®è·å–èŒè´£"><a href="#ä½¿ç”¨-proxy-ä»£ç†ï¼Œè®©ä¸­é—´å±‚æ‰¿æ‹…æ•°æ®è·å–èŒè´£" class="header-anchor">#</a> ä½¿ç”¨ proxy ä»£ç†ï¼Œè®©ä¸­é—´å±‚æ‰¿æ‹…æ•°æ®è·å–èŒè´£</h3> <p>ä¹‹å‰å®¢æˆ·ç«¯è¯·æ±‚æ•°æ®çš„æ—¶å€™ç›´æ¥å‘åå°è¯·æ±‚äº†ï¼Œæ˜¯ä¸è§„èŒƒçš„æ“ä½œï¼Œåº”è¯¥å®¢æˆ·ç«¯å…ˆèµ° node ä¸­é—´å±‚ï¼Œå†ç”±ä¸­é—´å±‚åšæ•°æ®è¯·æ±‚ã€‚</p> <p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Proxy åšä»£ç†å»è§£å†³ã€‚è¿™é‡Œç”¨çš„æ˜¯ expressï¼Œå¯ä»¥å€Ÿç”¨ç¬¬ä¸‰æ–¹åº“ express-http-proxy æ¥åšã€‚</p> <p>æ–‡æ¡£ï¼š<a href="https://github.com/villadora/express-http-proxy" target="_blank" rel="noopener noreferrer">https://github.com/villadora/express-http-proxy<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>ä¾‹å¦‚æˆ‘ä»¬æƒ³è¯·æ±‚çš„å®Œæ•´åœ°å€æ˜¯ http://47.95.113.63/ssr/api/news.json?secret=M5s2sPneDE</p> <p>ä»£ç†åœ°å€ï¼ŒæŠŠæœ¬åœ° localhost è¯·æ±‚ä»£ç†åˆ° http://47.95.113.63/</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token comment">// src/server/index.js</span>
<span class="token comment">// ...</span>
<span class="token comment">// ä»£ç†ï¼šå½“è¯·æ±‚åœ°å€ä¸º /api æ—¶ï¼Œæ‰§è¡Œä»£ç†</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/api&quot;</span><span class="token punctuation">,</span>
  <span class="token function">proxy</span><span class="token punctuation">(</span><span class="token string">&quot;http://47.95.113.63&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">proxyReqPathResolver</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// req.url : /news.json?secret=M5s2sPneDE</span>
      <span class="token keyword">return</span> <span class="token string">&quot;/ssr/api&quot;</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>å†æ›´æ”¹ axios çš„è¯·æ±‚åœ°å€ã€‚</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token comment">// src/containers/Home/store/actions.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getHomeList</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token parameter">dispatch</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      axios
        <span class="token comment">// get(&quot;http://47.95.113.63/ssr/api/news.json?secret=abcd&quot;)</span>
        <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/api/news.json?secret=abcd&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> list <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
          <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">changeList</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>ä»£ç†æˆåŠŸã€‚
<img src="/n-book/assets/img/network_2.240ad5aa.png" alt="network_2"></p> <p>å› ä¸ºåŒæ„çš„å› æ•…ï¼ŒgetHomeList è¿™ä¸ªè·å–æ•°æ®çš„æ–¹æ³•å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½ä¼šå„è‡ªæ‰§è¡Œä¸€æ¬¡ï¼Œä½†æ˜¯è¿™åªèƒ½åœ¨å®¢æˆ·ç«¯æ¸²æŸ“æ—¶è¯·æ±‚æˆåŠŸï¼Œ<strong>æœåŠ¡å™¨æ¸²æŸ“æ—¶ï¼Œå¹¶æ²¡æœ‰ä»£ç†åˆ° http://47.95.113.63 è¿™åå°åœ°å€ä¸Šï¼Œç›´æ¥è®¿é—®æœåŠ¡å™¨çš„æ ¹ç›®å½•æ˜¯è¯·æ±‚ä¸åˆ°æ•°æ®çš„ã€‚</strong></p> <p><img src="/n-book/assets/img/code_2.4f2c80be.png" alt="code_2"></p> <p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦åŒºåˆ†æœåŠ¡å™¨ç«¯è¯·æ±‚å’Œå®¢æˆ·ç«¯è¯·æ±‚æ¥åšä»£ç†ï¼ŒæœåŠ¡å™¨ç«¯è¯·æ±‚ä¸éœ€è¦ä»£ç†ï¼Œè€Œæ˜¯ç›´æ¥è®¿é—®åå°è·å–æ•°æ®ã€‚ç„¶åå†ä½¿ç”¨ axios ä¸­çš„ instance æ¥åˆç†åŒ–åˆ¤æ–­ä»£ç ã€‚</p> <p>æ–‡æ¡£ï¼š<a href="https://github.com/axios/axios#creating-an-instance" target="_blank" rel="noopener noreferrer">https://github.com/axios/axios#creating-an-instance<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/client/request.js</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">&quot;axios&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> instance <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// å®¢æˆ·ç«¯è¯·æ±‚æ•°æ®ï¼Œç›´æ¥ /</span>
  baseURL<span class="token punctuation">:</span> <span class="token string">&quot;/&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> instance<span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/server/request.js</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">&quot;axios&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> instance <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// æœåŠ¡ç«¯è¯·æ±‚æ•°æ®ï¼Œç›´æ¥è¯·æ±‚åå°åœ°å€</span>
  baseURL<span class="token punctuation">:</span> <span class="token string">&quot;http://47.95.113.63/ssr&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> instance<span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>ç”¨ axios åˆ›å»ºä¸€ä¸ªæ–°çš„ instance å¯¹è±¡å¹¶å¯¼å‡ºï¼Œåç»­åˆ†åˆ«è°ƒç”¨ã€‚</p> <p>è°ƒç”¨è·å–æ•°æ®æ–¹æ³•æ—¶ï¼Œä¼ ä¸€ä¸ª boolean å€¼åšæ ‡è®°ï¼Œä»¥åŒºåˆ†æ˜¯æœåŠ¡ç«¯è¿˜æ˜¯å®¢æˆ·ç«¯åœ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/containers/Home/index.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">class</span> <span class="token class-name">Home</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>list<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å®¢æˆ·ç«¯è¯·æ±‚æ•°æ®</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">getHomeList</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Home<span class="token punctuation">.</span><span class="token function-variable function">loadData</span> <span class="token operator">=</span> <span class="token parameter">store</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// æœåŠ¡ç«¯è¯·æ±‚æ•°æ®</span>
  <span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">getHomeList</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><div class="highlighted">Â </div><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/containers/Home/store/actions.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">CHANGE_LIST</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./constants&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> clientAxios <span class="token keyword">from</span> <span class="token string">&quot;../../../client/request&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> serverAxios <span class="token keyword">from</span> <span class="token string">&quot;../../../server/request&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">changeList</span> <span class="token operator">=</span> <span class="token parameter">list</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> <span class="token constant">CHANGE_LIST</span><span class="token punctuation">,</span>
  list
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getHomeList</span> <span class="token operator">=</span> <span class="token parameter">server</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// æ ¹æ®ä¼ å…¥çš„å€¼æ¥åˆ¤æ–­æ˜¯æœåŠ¡ç«¯æ¸²æŸ“è¿˜æ˜¯å®¢æˆ·ç«¯æ¸²æŸ“</span>
  <span class="token keyword">const</span> request <span class="token operator">=</span> server <span class="token operator">?</span> serverAxios <span class="token punctuation">:</span> clientAxios<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token parameter">dispatch</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç”¨instance æ›¿æ¢åŸæ¥çš„axioså¯¹è±¡å»å‘é€è¯·æ±‚</span>
    <span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/api/news.json?secret=abcd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> list <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
      <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">changeList</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>æ˜¯æœåŠ¡ç«¯è°ƒç”¨åˆ™ä½¿ç”¨å®ƒå¯¹åº”çš„ instance æ¥å‘è¯·æ±‚ï¼Œ</p> <p>æ˜¯å®¢æˆ·ç«¯è°ƒç”¨åˆ™ä½¿ç”¨å®ƒå¯¹åº”çš„ instance æ¥å‘è¯·æ±‚ã€‚</p> <p>è¿™æ ·å°±å¯ä»¥è§£å†³æœåŠ¡ç«¯è°ƒç”¨å¹¶ä¸éœ€è¦åšä»£ç†çš„é—®é¢˜ã€‚</p> <h3 id="redux-thunk-ä¸­çš„-withextraargument"><a href="#redux-thunk-ä¸­çš„-withextraargument" class="header-anchor">#</a> redux-thunk ä¸­çš„ withExtraArgument</h3> <p>ä¸Šé¢çš„è¯·æ±‚æ–¹å¼æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æ¯æ¬¡è°ƒç”¨æ–¹æ³•çš„æ—¶å€™éƒ½éœ€è¦å»å£°æ˜æ˜¯ä¸æ˜¯æ¥è‡ª server çš„è¯·æ±‚ï¼Œæ¯”è¾ƒç¹çï¼Œæˆ‘ä»¬å¯ä»¥ä»æºå¤´å»ç®¡ç†åŒºåˆ†ï¼Œè¿™å°±éœ€è¦ç”¨åˆ° redux-thunk ä¸­çš„ withExtraArgument æ–¹æ³•ã€‚</p> <blockquote><p>Redux Thunk supports injecting a custom argument using the <code>withExtraArgument</code> function.ï¼ˆæ³¨å…¥ä¸€ä¸ªè‡ªå®šä¹‰çš„å¯¹è±¡ï¼Œç„¶åå¯ä»¥åœ¨thunkè°ƒç”¨çš„ç¬¬ä¸‰ä¸ªå‚æ•°å¤„å–å‡ºã€‚ï¼‰</p></blockquote> <p>æ–‡æ¡£ï¼š<a href="https://github.com/reduxjs/redux-thunk#injecting-a-custom-argument" target="_blank" rel="noopener noreferrer">https://github.com/reduxjs/redux-thunk#injecting-a-custom-argument<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><img src="/n-book/assets/img/intro_1.0e76480c.png" alt="intro_1"></p> <p>server/src/store/index.js
<img src="/n-book/assets/img/code_3.4ef5fa4f.png" alt="code_3">
æŒ‰ç€å®˜æ–¹ç¤ºä¾‹æ”¹é€  thunk çš„å¼•ç”¨ã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/containers/Home/store/actions.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getHomeList</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// redux-thunkçš„ç¬¬2ï¼Œ3ä¸ªå‚æ•°ç”¨æ³•å‡ºç°</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">,</span> axiosInstance</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> axiosInstance<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/api/news.json?secret=abcd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> list <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
      <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">changeList</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>å› ä¸º redux-thunk çš„ä½œç”¨ï¼Œæ‰§è¡Œ getHomeList æ–¹æ³•çš„ç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ clientAxios/serverAxios çš„ instanceã€‚</p> <h3 id="renderroutes-æ–¹æ³•å®ç°å¯¹å¤šçº§è·¯ç”±çš„æ”¯æŒ"><a href="#renderroutes-æ–¹æ³•å®ç°å¯¹å¤šçº§è·¯ç”±çš„æ”¯æŒ" class="header-anchor">#</a> renderRoutes æ–¹æ³•å®ç°å¯¹å¤šçº§è·¯ç”±çš„æ”¯æŒ</h3> <p>ä¹‹å‰çš„æ–¹å¼ï¼Œåªèƒ½æ¸²æŸ“ä¸€çº§è·¯ç”±ã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> routes<span class="token punctuation">,</span> req</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Provider</span></span> <span class="token attr-name">store</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">StaticRouter</span></span> <span class="token attr-name">location</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>req<span class="token punctuation">.</span>path<span class="token punctuation">}</span></span> <span class="token attr-name">context</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
          </span><span class="token punctuation">{</span><span class="token comment">/*åªèƒ½æ¸²æŸ“ä¸€çº§è·¯ç”±(åªæœ‰ä¸€å±‚ Route)*/</span><span class="token punctuation">}</span><span class="token plain-text">
          </span><span class="token punctuation">{</span>routes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">route</span><span class="token punctuation">}</span></span><span class="token punctuation">/&gt;</span></span>
          <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">StaticRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Provider</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>æˆ‘ä»¬æ”¹æˆå¤šçº§è·¯ç”±åï¼Œéœ€è¦é…åˆ react-router-config çš„ renderRoutes æ–¹æ³•æ¥æ¸²æŸ“å¤šçº§è·¯ç”±ã€‚</p> <p>æ–‡æ¡£ï¼š<a href="https://github.com/ReactTraining/react-router/tree/master/packages/react-router-config#renderroutesroutes-extraprops---switchprops--" target="_blank" rel="noopener noreferrer">https://github.com/ReactTraining/react-router/tree/master/packages/react-router-config#renderroutesroutes-extraprops---switchprops--<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>è·¯ç”±æ–‡ä»¶ï¼š
server/src/Routes.js
<img src="/n-book/assets/img/code_4.4e97cd5a.png" alt="code_4"></p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/server/utils.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> StaticRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> renderRoutes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-config&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> routes<span class="token punctuation">,</span> req</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Provider</span></span> <span class="token attr-name">store</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">StaticRouter</span></span> <span class="token attr-name">location</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>req<span class="token punctuation">.</span>path<span class="token punctuation">}</span></span> <span class="token attr-name">context</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span><span class="token comment">/*è¿™é‡Œæ¸²æŸ“ä¸€çº§è·¯ç”±é‚£ä¸€å±‚çš„ä¸œè¥¿*/</span><span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token punctuation">{</span><span class="token function">renderRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">StaticRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Provider</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/client/index.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> renderRoutes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-config&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> routes <span class="token keyword">from</span> <span class="token string">&quot;../Routes&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">getClientStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Provider</span></span> <span class="token attr-name">store</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">BrowserRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span><span class="token comment">/*è¿™é‡Œä¹‹æ¸²æŸ“ä¸€çº§è·¯ç”±ï¼Œä¸éœ€è¦æŠŠäºŒçº§è·¯ç”±çš„ä¿¡æ¯ä¼ ç»™renderRoutes*/</span><span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token punctuation">{</span><span class="token function">renderRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">BrowserRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Provider</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„ä¸€çº§è·¯ç”±åªéœ€è¦ renderRoutes æœ€å¤–å±‚è·¯ç”±ä¿¡æ¯å°±å¯ä»¥ã€‚</p> <p>App ç»„ä»¶æ˜¯ä¸€çº§è·¯ç”±æ˜¾ç¤ºçš„ç»„ä»¶ï¼Œprops ä¼šæ¥å—åˆ°ä¼ è¿‡æ¥çš„è·¯ç”±ä¿¡æ¯å¯¹è±¡ï¼Œåœ¨è¿™é‡Œå»æ¸²æŸ“äºŒçº§è·¯ç”±ã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/App.js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Header <span class="token keyword">from</span> <span class="token string">&quot;./components/Header&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> renderRoutes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-config&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token parameter">props</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Header</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span><span class="token comment">/*æ¸²æŸ“äºŒçº§è·¯ç”±*/</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token punctuation">{</span><span class="token function">renderRoutes</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>route<span class="token punctuation">.</span>routes<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>ä¸€çº§è·¯ç”±å¯¹åº”çš„å°±æ˜¯ App ç»„ä»¶ï¼Œæ‰€ä»¥éœ€è¦åœ¨è¿™ä¸ªç»„ä»¶é‡Œå»æ¸²æŸ“äºŒçº§è·¯ç”±ã€‚è¿™æ—¶å€™å°±éœ€è¦ renderRoutes ç¬¬äºŒå±‚è·¯ç”±ä¿¡æ¯ã€‚</strong></p> <p>ï¼ˆåœ¨å…¶ä»–ç»„ä»¶å…±ç”¨çš„ Headerï¼Œå¯ä»¥æ”¾åœ¨è¿™é‡Œï¼Œåªè¦è®¿é—®äº† / æ ¹è·¯å¾„ï¼ŒHeader ç»„ä»¶æ€»ä¼šå‡ºç°ã€‚ï¼‰</p> <p>æ‰“å°è¾“å‡º props.route.routesï¼Œå…¶å®å°±æ˜¯äºŒçº§è·¯ç”±çš„å¯¹è±¡ä¿¡æ¯ã€‚
<img src="/n-book/assets/img/console_3.5d48e517.png" alt="console_3"></p> <p>é…åˆä½¿ç”¨ renderRoutes æ–¹æ³•å°±è¿™æ ·æ—¢å¯å®ç°å¤šçº§è·¯ç”±æ¸²æŸ“ã€‚</p> <h3 id="ç™»é™†åŠŸèƒ½"><a href="#ç™»é™†åŠŸèƒ½" class="header-anchor">#</a> ç™»é™†åŠŸèƒ½</h3> <p>æ ¹æ® login çš„å€¼æ˜¾ç¤ºä¸åŒçš„å†…å®¹ï¼š</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><br><div class="highlighted">Â </div><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/components/Header/index.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span></span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">é¦–é¡µ</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Link</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token punctuation">{</span><span class="token comment">/*æ ¹æ®loginçš„å€¼æ˜¾ç¤ºä¸åŒçš„å†…å®¹*/</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token punctuation">{</span>login <span class="token operator">?</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Fragment</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span></span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/login<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">ç¿»è¯‘åˆ—è¡¨</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Link</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleLogout<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">é€€å‡º</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Fragment</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleLogin<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">ç™»é™†</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>åœ¨æœåŠ¡ç«¯æ¸²æŸ“å‰ï¼Œè·å– login çš„å€¼ï¼Œä»¥ä¾¿æ¸²æŸ“ Header çš„å†…å®¹ã€‚</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token comment">// src/App.js</span>
<span class="token comment">// ...</span>
App<span class="token punctuation">.</span><span class="token function-variable function">loadData</span> <span class="token operator">=</span> <span class="token parameter">store</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>actions<span class="token punctuation">.</span><span class="token function">getHeaderInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/components/Header/store/actions.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">CHANGE_LOGIN</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./constants&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">changeLogin</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> <span class="token constant">CHANGE_LOGIN</span><span class="token punctuation">,</span>
  value
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">,</span> axiosInstance</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> axiosInstance<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/api/login.json?secret=abcd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// ç™»å½•æˆåŠŸ</span>
      <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">changeLogin</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">logout</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">,</span> axiosInstance</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> axiosInstance<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/api/logout.json?secret=abcd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// é€€å‡ºç™»å½•</span>
      <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">changeLogin</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getHeaderInfo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">,</span> axiosInstance</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> axiosInstance<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/api/isLogin.json?secret=abcd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// è·å–ç™»å½•çŠ¶æ€(true / false)</span>
      <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">changeLogin</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>login<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>å†ç”± reducer å»æ”¹å˜ store é‡Œ login çš„å€¼ã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/components/Header/store/reducer.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">CHANGE_LOGIN</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./constants&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> defaultState <span class="token operator">=</span> <span class="token punctuation">{</span>
  login<span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> defaultState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token constant">CHANGE_LOGIN</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>state<span class="token punctuation">,</span>
        login<span class="token punctuation">:</span> action<span class="token punctuation">.</span>value
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><img src="/n-book/assets/img/code_5.1c5fdb32.png" alt="code_5"></p> <h3 id="cookies-æºå¸¦é—®é¢˜"><a href="#cookies-æºå¸¦é—®é¢˜" class="header-anchor">#</a> cookies æºå¸¦é—®é¢˜</h3> <p>æµç¨‹ï¼š</p> <ol><li>åˆšè¿›å…¥é¡µé¢çš„æ—¶å€™ï¼Œå¤„äºéç™»å½•çŠ¶æ€ã€‚</li> <li>ç”¨æˆ·ç‚¹å‡»ç™»å½•æŒ‰é’®ï¼Œæ‰“æ¥å£è¿›è¡Œç™»å½•æ“ä½œã€‚</li> <li>æµè§ˆå™¨å‘è¯·æ±‚ç»™ä¸­é—´å±‚ï¼Œä¹Ÿå°±æ˜¯ Node æœåŠ¡å™¨</li> <li>Node æœåŠ¡å™¨è½¬å‘è¯·æ±‚ç»™åå° api æœåŠ¡å™¨ï¼Œè¿›è¡Œç™»å½•</li> <li>åå° api æœåŠ¡å™¨ç”Ÿæˆ cookiesï¼Œè¿”å›æ—¶å†™å…¥æµè§ˆå™¨</li> <li>æµè§ˆå™¨é‡Œæœ‰ cookiesï¼Œç™»å½•æˆåŠŸ</li> <li>ä½†ç”¨æˆ·é‡æ–°åˆ·æ–°æµè§ˆå™¨çš„æ—¶å€™</li> <li>æµè§ˆå™¨å‘ HTTP è¯·æ±‚ htmlï¼ˆè¯·æ±‚æ˜¯æºå¸¦ç€ cookies çš„ï¼‰</li> <li>Node æœåŠ¡å™¨è¿›è¡ŒæœåŠ¡å™¨æ¸²æŸ“</li> <li>è¿›è¡ŒæœåŠ¡å™¨æ¸²æŸ“å‰ï¼Œé¦–å…ˆè¦å»åå° api æœåŠ¡å™¨è¯·æ±‚æ•°æ®ï¼Œä½†æ˜¯è¿™æ—¶å€™çš„è¯·æ±‚æ˜¯ä¸æºå¸¦ cookies çš„ï¼ˆnode ç«¯ä¸æ˜¯æµè§ˆå™¨ï¼‰ï¼Œæ‰€ä»¥é€ æˆäº†é‡æ–°åˆ·æ–°é¡µé¢ç™»å½•çŠ¶æ€ä¸å¯¹çš„ bug</li></ol> <p>ä¸‹é¢æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p> <p>å…¶å®åªéœ€è¦åœ¨ Node æœåŠ¡å™¨è½¬å‘è¯·æ±‚çš„æ—¶å€™ï¼Œå¸¦ä¸Šå®¢æˆ·ç«¯ä¹‹å‰çš„ cookies å»è¯·æ±‚ï¼Œé—®é¢˜å°±è§£å†³äº†ã€‚
å‘è¯·æ±‚çš„ axios æ–¹æ³•ï¼Œå¯ä»¥åŠ å¸¦ä¸€ä¸ª headers å¯¹è±¡ï¼Œå¾€é‡ŒåŠ  cookie å‚æ•°ã€‚</p> <p>ä¸ºäº†æ¥æ”¶ä¸€ä¸ª req å‚æ•°ï¼ŒåŸæ¥ createInstance æ˜¯ä¸ªå¯¹è±¡ï¼Œå°†å…¶æ”¹é€ æˆå‡½æ•°å½¢å¼ã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/server/request.js</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">&quot;axios&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">createInstance</span> <span class="token operator">=</span> <span class="token parameter">req</span> <span class="token operator">=&gt;</span>
  axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    baseURL<span class="token punctuation">:</span> <span class="token string">&quot;http://47.95.113.63/ssr&quot;</span><span class="token punctuation">,</span>
    headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      cookie<span class="token punctuation">:</span> req<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;cookie&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&quot;&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> createInstance<span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>å¯¹äº req å‚æ•°ï¼Œç”± express æ•è·å¹¶ä¼ é€’ç»™ getStore()æ–¹æ³•ã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><div class="highlighted">Â </div><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/server/index.js</span>
<span class="token comment">// ...</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">getStore</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>åœ¨åˆ›å»ºæœåŠ¡ç«¯çš„ store æ—¶æŠŠ req ä¼ è¿‡å»ï¼Œè¿™æ ·è¯·æ±‚çš„ headers ä¸­å°±å¸¦æœ‰ cookie ä¿¡æ¯äº†ã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/store/index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createStore<span class="token punctuation">,</span> applyMiddleware<span class="token punctuation">,</span> combineReducers <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;redux&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> thunk <span class="token keyword">from</span> <span class="token string">&quot;redux-thunk&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> reducer <span class="token keyword">as</span> homeReducer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../containers/Home/store&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> reducer <span class="token keyword">as</span> headerReducer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../components/Header/store&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> clientAxios <span class="token keyword">from</span> <span class="token string">&quot;../client/request&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> serverAxios <span class="token keyword">from</span> <span class="token string">&quot;../server/request&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> reducer <span class="token operator">=</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  home<span class="token punctuation">:</span> homeReducer<span class="token punctuation">,</span>
  header<span class="token punctuation">:</span> headerReducer
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// åˆ›å»ºæœåŠ¡ç«¯ store</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getStore</span> <span class="token operator">=</span> <span class="token parameter">req</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createStore</span><span class="token punctuation">(</span>
    reducer<span class="token punctuation">,</span>
    <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>thunk<span class="token punctuation">.</span><span class="token function">withExtraArgument</span><span class="token punctuation">(</span><span class="token function">serverAxios</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getClientStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> defaultState <span class="token operator">=</span> window<span class="token punctuation">.</span>context<span class="token punctuation">.</span>state<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">createStore</span><span class="token punctuation">(</span>
    reducer<span class="token punctuation">,</span>
    defaultState<span class="token punctuation">,</span>
    <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>thunk<span class="token punctuation">.</span><span class="token function">withExtraArgument</span><span class="token punctuation">(</span>clientAxios<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="æ›¾ç»çš„é—®é¢˜ï¼šä»¤ä½ æ·±åˆ»çš„-bug"><a href="#æ›¾ç»çš„é—®é¢˜ï¼šä»¤ä½ æ·±åˆ»çš„-bug" class="header-anchor">#</a> æ›¾ç»çš„é—®é¢˜ï¼šä»¤ä½ æ·±åˆ»çš„ Bug ?</h3> <p>æœåŠ¡ç«¯æ¸²æŸ“å‰çš„ App ç»„ä»¶è¦æ‰§è¡Œçš„ loadData æ–¹æ³•ï¼š</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code>App<span class="token punctuation">.</span><span class="token function-variable function">loadData</span> <span class="token operator">=</span> <span class="token parameter">store</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>actions<span class="token punctuation">.</span><span class="token function">getHeaderInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>App ç»„ä»¶è¿”å›çš„æ•°æ®å…¶å®æ˜¯ promiseï¼Œè€Œè¿™æ—¶å´æ²¡æœ‰ return å›å»ã€‚
åœ¨æœåŠ¡ç«¯æ¸²æŸ“çš„æ—¶å€™ï¼Œè¦ç­‰åˆ°æ‰€æœ‰çš„ promise éƒ½è·å–æ•°æ®è¿”å›æˆåŠŸï¼Œæ‰å»æ‰§è¡Œæ¸²æŸ“é¡µé¢çš„å†…å®¹ã€‚</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token comment">// ç”¨äºç®¡ç†å¤šä¸ªpromiseè¯·æ±‚çš„æ‰§è¡Œç»“æœ</span>
<span class="token keyword">const</span> promises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
matchedRoutes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>route<span class="token punctuation">.</span>loadData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// item.route.loadData() ç”¨äºè·å–å¼‚æ­¥æ•°æ®</span>
    <span class="token comment">// è¿”å›æ•°ç»„é‡Œçš„æ˜¯Promiseå¯¹è±¡</span>
    promises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>route<span class="token punctuation">.</span><span class="token function">loadData</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> store<span class="token punctuation">,</span> routes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>æ‰€ä»¥ loadData åº”è¯¥è¦ return å›å»ï¼Œpromises æ•°ç»„é‚£è¾¹æ‰èƒ½æ¥å—åˆ°ä¸€ä¸ª Promise å¯¹è±¡ã€‚
è¿™æ ·æœåŠ¡ç«¯æ¸²æŸ“å‰æ¥ Promise.all æ”¶åˆ°çš„å¯¹è±¡æ‰æ˜¯ Promiseï¼Œè€Œä¸æ˜¯ undefinedã€‚</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code>App<span class="token punctuation">.</span><span class="token function-variable function">loadData</span> <span class="token operator">=</span> <span class="token parameter">store</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>actions<span class="token punctuation">.</span><span class="token function">getHeaderInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="ç»†èŠ‚é—®é¢˜å¤„ç†"><a href="#ç»†èŠ‚é—®é¢˜å¤„ç†" class="header-anchor">#</a> ç»†èŠ‚é—®é¢˜å¤„ç†</h2> <h3 id="ç»Ÿä¸€ç®¡ç†å¯†é’¥"><a href="#ç»Ÿä¸€ç®¡ç†å¯†é’¥" class="header-anchor">#</a> ç»Ÿä¸€ç®¡ç†å¯†é’¥</h3> <p>url ä¸Šæ‰€å¸¦çš„ç»Ÿä¸€çš„å‚æ•°ï¼Œå¯ä»¥æ”¾åˆ° axios çš„ Instance é‡Œç»Ÿä¸€è°ƒç”¨ã€‚
æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½è¦è¿™æ ·ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥å¼•å…¥ä¸€ä¸ªå…¬å…±çš„ config æ–‡ä»¶å†å»å¼•ç”¨ã€‚</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token comment">// src/server/request.js</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">&quot;axios&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// config é‡Œå†™ç€å„ç±»ä¿¡æ¯</span>
<span class="token keyword">import</span> config <span class="token keyword">from</span> <span class="token string">&quot;../config&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">createInstance</span> <span class="token operator">=</span> <span class="token parameter">req</span> <span class="token operator">=&gt;</span>
  axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    baseURL<span class="token punctuation">:</span> <span class="token string">&quot;http://47.95.113.63/ssr&quot;</span><span class="token punctuation">,</span>
    headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      cookie<span class="token punctuation">:</span> req<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;cookie&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&quot;&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    params<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      secret<span class="token punctuation">:</span> config<span class="token punctuation">.</span>secret
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> createInstance<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_404-é¡µé¢"><a href="#_404-é¡µé¢" class="header-anchor">#</a> 404 é¡µé¢</h3> <p>é…ç½®è·¯ç”±ï¼Œæ–°å¢ä¸€ä¸ªæ²¡æœ‰è·¯å¾„æ—¶å¯¹åº”çš„ç»„ä»¶ï¼š</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  component<span class="token punctuation">:</span> NotFound<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>server/src/Routes.js
<img src="/n-book/assets/img/code_6.d5e74c37.png" alt="code_6"></p> <p>æœåŠ¡ç«¯æ¸²æŸ“çš„ StaticRouter ç»„ä»¶ä¸­ï¼Œcontenxt å¯¹è±¡ä¼šä¼ ç»™å®ƒçš„æ‰€æœ‰å­ç»„ä»¶ï¼Œå­ç»„ä»¶å¯ä»¥é€šè¿‡ props.staticContext è·å–åˆ°è¿™ä¸ªå¯¹è±¡çš„å€¼ã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted">Â </div><br><br><br><div class="highlighted">Â </div><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/server/utils.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> routes<span class="token punctuation">,</span> req<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Provider</span></span> <span class="token attr-name">store</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span><span class="token comment">/*StaticRouterçš„contextå¯¹è±¡ä¼šä¼ ç»™å®ƒçš„æ‰€æœ‰å­ç»„ä»¶*/</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">StaticRouter</span></span> <span class="token attr-name">location</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>req<span class="token punctuation">.</span>path<span class="token punctuation">}</span></span> <span class="token attr-name">context</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>context<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span><span class="token function">renderRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">StaticRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Provider</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>é‚£æˆ‘ä»¬å¦‚ä½•èƒ½çŸ¥é“å½“å‰é¡µæ˜¯ 404 é¡µé¢ï¼Ÿ</p> <p>å¯ä»¥åœ¨ 404 é¡µé¢å¯¹åº”çš„ç»„ä»¶ NotFound é‡Œå»æ”¹å˜ staticContext çš„å€¼ï¼Œåªæœ‰åœ¨ 404 é¡µé¢ä¸­ï¼Œæ‰ä¼šä½¿ staticContext.NOT_FOUND çš„å€¼ä¸º trueã€‚</p> <p>componentWillMount æœåŠ¡å™¨ç«¯ä¹Ÿä¼šè¿è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬å°†æ”¹å˜ staticContext çš„æ“ä½œæ”¾åˆ°è¿™é‡Œã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/containers/NotFound/index.js</span>
<span class="token keyword">class</span> <span class="token class-name">NotFound</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token comment">// componentWillMount æœåŠ¡å™¨ç«¯ä¹Ÿä¼šè¿è¡Œ</span>
  <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> staticContext <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    staticContext <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>staticContext<span class="token punctuation">.</span><span class="token constant">NOT_FOUND</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">404, sorry, page not found</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>å› ä¸ºåœ¨å®¢æˆ·ç«¯æ¸²æŸ“ä¸Šï¼Œæ²¡æœ‰ StaticRouter è¿™ä¸ªç»„ä»¶ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰ staticContext è¿™ä¸ªå€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åœ¨ç¡®ä¿æœ‰ staticContext çš„å‰æä¸‹ï¼Œæ‰å»å¾€ staticContext é‡Œæ·»åŠ ä¸€ä¸ª NOT_FOUND å¯¹è±¡å¹¶è®¾ä¸º trueã€‚</p> <p>æœ€åï¼Œè¦è®¾ç½® 404 é¡µé¢è¿”å›çš„ status ç ä¸º 404ã€‚</p> <p>è¿™ä¸ªå€¼é»˜è®¤ä¸º 200ã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/server/index.js</span>
<span class="token comment">// ...</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">getStore</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ ¹æ®è·¯ç”±çš„è·¯å¾„ï¼Œæ¥å¾€storeé‡Œé¢åŠ æ•°æ®</span>
  <span class="token keyword">const</span> matchedRoutes <span class="token operator">=</span> <span class="token function">matchRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> req<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è®©matchRoutesé‡Œé¢æ‰€æœ‰çš„ç»„ä»¶ï¼Œå¯¹åº”çš„loadDataæ–¹æ³•æ‰§è¡Œä¸€æ¬¡</span>
  <span class="token keyword">const</span> promises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  matchedRoutes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>route<span class="token punctuation">.</span>loadData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      promises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>route<span class="token punctuation">.</span><span class="token function">loadData</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ‰€æœ‰ä¸€éƒ¨æ•°æ®éƒ½è·å–åˆ°åï¼Œå†æœåŠ¡ç«¯æ¸²æŸ“é¡µé¢</span>
  Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> routes<span class="token punctuation">,</span> req<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token constant">NOT_FOUND</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è®¾ç½®ç½‘ç»œè¯·æ±‚çš„statusç ä¸º404</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>è¿™é‡Œè¦ç•™æ„åˆ°ä¸€ç‚¹ï¼š</p> <p>ä¸ºä»€ä¹ˆè¦æŠŠ render() èµ‹ç»™ä¸€ä¸ªå˜é‡ htmlï¼Ÿ</p> <p>è¿™æ˜¯ä¸ºäº†åšåˆ¤æ–­ï¼Œres.send è¿”å›å‰ï¼Œrender å‡½æ•°å·²æ‰§è¡Œå¥½ï¼Œå³é¡µé¢å·²æ¸²æŸ“å¥½ï¼Œå†æ ¹æ®æ¡ä»¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p> <h3 id="å®ç°æœåŠ¡å™¨ç«¯-301-é‡å®šå‘"><a href="#å®ç°æœåŠ¡å™¨ç«¯-301-é‡å®šå‘" class="header-anchor">#</a> å®ç°æœåŠ¡å™¨ç«¯ 301 é‡å®šå‘</h3> <p>å› ä¸º <code>&lt;Redirect /&gt;</code> ä»…é™äºå®¢æˆ·ç«¯é‡å®šå‘ï¼Œå½“æ²¡æœ‰æœªç™»é™†çŠ¶æ€æ—¶å»è®¿é—®å…¶ä»–é¡µé¢ï¼ˆåº”å½“æ²¡æœ‰æƒé™è®¿é—®çš„ï¼‰ï¼ŒæœåŠ¡ç«¯ä¼šè¿”å›é¡µé¢å†…å®¹ï¼Œç„¶åå®¢æˆ·ç«¯å†è¿›è¡Œé‡å®šå‘è·³è½¬åˆ°å…¶ä»–é¡µé¢ï¼Œè¿™æ˜¯ä¸å¤ªåˆç†çš„ã€‚
æ‰€ä»¥æˆ‘ä»¬è¦åšåˆ°æœåŠ¡ç«¯é‡å®šå‘ã€‚</p> <p>åœ¨é‡å®šå‘æ—¶ï¼Œreact-router-config éƒ½ä¼šå¸®æˆ‘åšä¸€ä»¶äº‹ï¼šå¾€ context é‡Œå¡«å……è¿™æ ·çš„å†…å®¹ã€‚
<img src="/n-book/assets/img/console_4.2d1ddd0f.png" alt="console_4"></p> <p>æ–‡æ¡£ï¼š<a href="https://github.com/ReactTraining/react-router/tree/master/packages/react-router-config" target="_blank" rel="noopener noreferrer">https://github.com/ReactTraining/react-router/tree/master/packages/react-router-config<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted">Â </div><br><br><br><div class="highlighted">Â </div><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/server/utils.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> routes<span class="token punctuation">,</span> req<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Provider</span></span> <span class="token attr-name">store</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span><span class="token comment">/*StaticRouterçš„contextå¯¹è±¡ä¼šä¼ ç»™å®ƒçš„æ‰€æœ‰å­ç»„ä»¶*/</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">StaticRouter</span></span> <span class="token attr-name">location</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>req<span class="token punctuation">.</span>path<span class="token punctuation">}</span></span> <span class="token attr-name">context</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>context<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span><span class="token function">renderRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">StaticRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Provider</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/server/index.js</span>
<span class="token comment">// ...</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">getStore</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ ¹æ®è·¯ç”±çš„è·¯å¾„ï¼Œæ¥å¾€storeé‡Œé¢åŠ æ•°æ®</span>
  <span class="token keyword">const</span> matchedRoutes <span class="token operator">=</span> <span class="token function">matchRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> req<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è®©matchRoutesé‡Œé¢æ‰€æœ‰çš„ç»„ä»¶ï¼Œå¯¹åº”çš„loadDataæ–¹æ³•æ‰§è¡Œä¸€æ¬¡</span>
  <span class="token keyword">const</span> promises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  matchedRoutes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>route<span class="token punctuation">.</span>loadData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      promises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>route<span class="token punctuation">.</span><span class="token function">loadData</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> routes<span class="token punctuation">,</span> req<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// res.send è¿”å›å‰ï¼Œé¡µé¢å·²ç»æ¸²æŸ“å¥½ã€‚</span>
    <span class="token comment">// é‡å®šå‘æ—¶ï¼Œreact-router-config ä¼šç»™ context.action æ³¨å…¥è¿™ä¸ªå€¼</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&quot;REPLACE&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token number">301</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token constant">NOT_FOUND</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>è¿™æ ·å°±å¯ä»¥è®¾ç½® status ç ä¸º 301ï¼Œå¹¶è·³è½¬åˆ° context.url é‡Œçš„é‡å®šå‘é¡µé¢ã€‚</p> <h3 id="å®¹é”™å¤„ç†æ•°æ®è¯·æ±‚å¤±è´¥æƒ…å†µä¸‹-promise-çš„å¤„ç†"><a href="#å®¹é”™å¤„ç†æ•°æ®è¯·æ±‚å¤±è´¥æƒ…å†µä¸‹-promise-çš„å¤„ç†" class="header-anchor">#</a> å®¹é”™å¤„ç†æ•°æ®è¯·æ±‚å¤±è´¥æƒ…å†µä¸‹ promise çš„å¤„ç†</h3> <p>ç›®å‰å¯¹æœåŠ¡ç«¯æ¸²æŸ“çš„æ–¹æ³•æ˜¯è¿™æ ·çš„ï¼š</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token comment">// ...</span>
<span class="token keyword">const</span> promises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
matchedRoutes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>route<span class="token punctuation">.</span>loadData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    promises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>route<span class="token punctuation">.</span><span class="token function">loadData</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> routes<span class="token punctuation">,</span> req<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&quot;REPLACE&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token number">301</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token constant">NOT_FOUND</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>è¿™ç§æƒ…å†µä¸‹ï¼Œåªè¦å…¶ä¸­çš„ä¸€ä¸ªç»„ä»¶ loadData è¿”å›çš„ Promise å¯¹è±¡æ˜¯å¤±è´¥çš„ï¼Œé‚£å…¨éƒ¨çš„ç»„ä»¶éƒ½ä¸ä¼šè¢«æ¸²æŸ“ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬åšå®¹é”™å¤„ç†ï¼Œä½¿å¾—å°±ç®—å…¶ä¸­ä¸€ä¸ªç»„ä»¶è·å–æ•°æ®å¤±è´¥ï¼Œå…¶ä»–æˆåŠŸè·å–æ•°æ®çš„ç»„ä»¶ä¾æ—§å¯ä»¥æ˜¾ç¤ºã€‚</p> <p><strong>æˆ‘ä»¬çš„åŸåˆ™æ˜¯ï¼Œå¦‚æœæŸä¸ªç»„ä»¶èƒ½æ­£å¸¸åŠ è½½ï¼Œå°±åº”è¯¥æŠŠå®ƒæ˜¾ç¤ºå‡ºæ¥ï¼Œè€Œä¸è¦å—åˆ°å…¶ä»–ç»„ä»¶å¤±è´¥çš„å½±å“ã€‚</strong></p> <p>å‡è®¾ä¸€ä¸ªé¡µé¢è¦åŠ è½½ A,B,C,D å››ä¸ªç»„ä»¶ï¼Œè¿™å››ä¸ªç»„ä»¶éƒ½éœ€è¦æœåŠ¡å™¨ç«¯åŠ è½½æ•°æ®ã€‚</p> <p>è€Œ A ç»„ä»¶åŠ è½½æ•°æ®é”™è¯¯ï¼Œå¯¹äºå‰©ä¸‹çš„ç»„ä»¶å¯èƒ½æœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š</p> <ol><li><p>B, C, D ç»„ä»¶æ•°æ®å·²ç»åŠ è½½å®Œæˆäº†ã€‚</p></li> <li><p>B, C, D æ¥å£æ¯”è¾ƒæ…¢ï¼ŒB, C, D ç»„ä»¶æ•°æ®æ²¡æœ‰åŠ è½½å®Œæˆã€‚</p></li></ol> <p>ç¬¬ä¸€ç§æƒ…å†µï¼Œç»™ Promise.all åŠ ä¸Š catchï¼Œ<strong>Promise.all().then().catch()</strong>ï¼Œåœ¨ catch ä¸­æ‰§è¡Œå’Œ then ä¸€æ ·çš„æ“ä½œã€‚è¿™æ · Promise.all() å°±ç®—å¤±è´¥ï¼Œä¹Ÿä¼šæ‰§è¡Œ catch é‡Œçš„å†…å®¹ï¼Œæ¸²æŸ“å‡º B,C,D ç»„ä»¶çš„å†…å®¹ã€‚</p> <p>ä½†æ˜¯ç¬¬äºŒç§æƒ…å†µï¼Œå› ä¸ºæ¥å£é€Ÿåº¦æ…¢ï¼Œå½“ B,C,D è¿˜æ²¡æœ‰è¿”å›å†…å®¹æ—¶ï¼Œå› ä¸º A ç»„ä»¶åŠ è½½å¤±è´¥äº†ï¼Œ<strong>Promise.all()</strong> åˆ™ä¼šç›´æ¥å»æ‰§è¡Œ <strong>catch()</strong> ä¸­çš„å†…å®¹ï¼Œé‚£å°±ç®—æ‰§è¡Œäº†æ¸²æŸ“æ–¹æ³•ï¼Œé¡µé¢ä¹Ÿä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œå› ä¸º B,C,D è¿˜æ²¡æœ‰è¿”å›æ•°æ®ã€‚</p> <p>æ‰€ä»¥æˆ‘ä»¬å»æ‰ Promise.all ä¸Šçš„ catch æ–¹æ³•ï¼Œåœ¨ loadData è¿”å›çš„å¯¹è±¡çš„åŸºç¡€ä¸Šï¼Œå†å°è£…ä¸€ä¸ª Promise å¯¹è±¡ï¼Œæ— è®ºç»„ä»¶æˆåŠŸè¿˜æ˜¯å¤±è´¥éƒ½è¿”å› resolveï¼Œè¿™æ · promises æ•°ç»„ä¸­çš„æ‰€æœ‰ Promise å¯¹è±¡éƒ½æ˜¯ resolve çŠ¶æ€çš„ã€‚</p> <p>è¿™æ ·ç¡®ä¿äº†æ¯ä¸€ä¸ªæœ‰ loadData æ–¹æ³•çš„å¯¹è±¡éƒ½æœ‰æ‰§è¡Œ loadData æ–¹æ³•ï¼Œå°±ç®—æ¥å£æˆ–æ˜¯ç½‘é€Ÿæ…¢ä¹Ÿä¼šç­‰å¾…è¿”å›ç»“æœï¼Œå¾—åˆ°äº†ç»“æœåæ‰è¿”å›çš„ resolveï¼Œä¹Ÿå› ä¸ºæ‰€æœ‰ loadData è¿”å›çš„ Promise å¯¹è±¡éƒ½æ˜¯ resolveï¼Œæ‰€ä»¥ Promise.all èµ°çš„æ˜¯ then() æ–¹æ³•ã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/server/index.js</span>
matchedRoutes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>route<span class="token punctuation">.</span>loadData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// æˆåŠŸæˆ–å¤±è´¥éƒ½è¿”å›resolveï¼Œæ‰€ä»¥Promise.allè‚¯å®šä¼šèµ°then()ï¼ŒæŠŠèƒ½æ¸²æŸ“çš„å…¨æ¸²æŸ“å‡ºæ¥</span>
      item<span class="token punctuation">.</span>route
        <span class="token punctuation">.</span><span class="token function">loadData</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    promises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// promises = [ a, b, c, d ]</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> routes<span class="token punctuation">,</span> req<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&quot;REPLACE&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token number">301</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token constant">NOT_FOUND</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="ä¸€ä¸ª-loaddata-çš„æ½œåœ¨é—®é¢˜"><a href="#ä¸€ä¸ª-loaddata-çš„æ½œåœ¨é—®é¢˜" class="header-anchor">#</a> ä¸€ä¸ª loadData çš„æ½œåœ¨é—®é¢˜</h3> <p>ä¾‹å¦‚ Home ç»„ä»¶åœ¨å¯¼å‡ºçš„æ—¶å€™ï¼š</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">connect</span><span class="token punctuation">(</span>
  mapStateToProps<span class="token punctuation">,</span>
  mapDispatchToProps
<span class="token punctuation">)</span><span class="token punctuation">(</span>Home<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>è¿™é‡Œå¯¼å‡ºçš„å…¶å®å·²ç»ä¸æ˜¯ Home ç»„ä»¶äº†ï¼Œè€Œæ˜¯ç»è¿‡äº† connect æ–¹æ³•å°è£…åçš„ Home ç»„ä»¶ï¼ˆé«˜é˜¶ç»„ä»¶ï¼‰ï¼Œè€Œæˆ‘ä»¬å´åœ¨ Home ä¸‹ç›´æ¥ç»‘å®šäº† loadData æ–¹æ³•ã€‚</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code>Home<span class="token punctuation">.</span><span class="token function-variable function">loadData</span> <span class="token operator">=</span> <span class="token parameter">store</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">getHomeList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>åœ¨ react-router-config è°ƒç”¨ loadData æ–¹æ³•çš„æ—¶å€™ï¼Œè¿™å°±å¯èƒ½æ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºè°ƒç”¨çš„æ˜¯åŸæ¥ Home ä¸‹çš„ loadData æ–¹æ³•ï¼Œè€Œæˆ‘ä»¬ export å‡ºå»çš„å´æ˜¯ä¸€ä¸ª connect()(Home) ç»„ä»¶ã€‚</p> <p>ä¹‹æ‰€ä»¥æ²¡æœ‰å‡ºé”™æ˜¯å› ä¸º react-redux å°† Home ä¸‹çš„æ‰€æœ‰æ–¹æ³•åŸå°ä¸åŠ¨çš„ä¼ ç»™äº†æ–°çš„ connect()(Home) ç»„ä»¶ã€‚ä½†æ˜¯æˆ‘ä»¬åŒæ ·å¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›æ›´æ”¹ï¼Œå¯¼å‡ºçš„æ˜¯ä¸€ä¸ª ExportHome é«˜é˜¶ç»„ä»¶ã€‚</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">const</span> ExportHome <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>
  mapStateToProps<span class="token punctuation">,</span>
  mapStateToDispatch
<span class="token punctuation">)</span><span class="token punctuation">(</span>Home<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ExportHome<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>è€Œ loadData ç»‘å®šåœ¨ ExportHome ä¸Šï¼Œè¿™æ ·ç¡®ä¿äº†å¯¼å‡ºçš„ç»„ä»¶ä¸Šæ˜¯ä¸€å®šæœ‰ loadData æ–¹æ³•çš„ã€‚</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code>ExportHome<span class="token punctuation">.</span><span class="token function-variable function">loadData</span> <span class="token operator">=</span> <span class="token parameter">store</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">getHomeList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="å¤„ç†-ssr-æ¡†æ¶ä¸­çš„-css-æ ·å¼"><a href="#å¤„ç†-ssr-æ¡†æ¶ä¸­çš„-css-æ ·å¼" class="header-anchor">#</a> å¤„ç† SSR æ¡†æ¶ä¸­çš„ CSS æ ·å¼</h2> <h3 id="å®ç°-css-æ ·å¼çš„æœåŠ¡å™¨ç«¯æ¸²æŸ“"><a href="#å®ç°-css-æ ·å¼çš„æœåŠ¡å™¨ç«¯æ¸²æŸ“" class="header-anchor">#</a> å®ç° CSS æ ·å¼çš„æœåŠ¡å™¨ç«¯æ¸²æŸ“</h3> <p>ä¹‹å‰ç”¨ webpack çš„ isomorphic åªæ˜¯åšåˆ°äº†åœ¨æœåŠ¡ç«¯æ‰“åŒ… CSSï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æŠŠ CSS æ”¾åœ¨æ¸²æŸ“å†…å®¹é‡Œä¸€å—è¿”å›ç»™æµè§ˆå™¨ï¼Œä»è€Œä¼šå¯¼è‡´åœ¨å®¢æˆ·ç«¯é‡æ–°æ¸²æŸ“çš„æ—¶å€™ï¼Œå‡ºç°æ ·å¼æŠ–åŠ¨ã€‚(å› ä¸ºæœåŠ¡ç«¯æ¸²æŸ“è¿”å›æ˜¯æ•°æ®æ˜¯æ²¡æœ‰æ ·å¼å†…å®¹çš„ï¼Œä¸€æ—¦ç¦ç”¨äº† JSï¼Œæ ·å¼ä¸ºç©ºï¼Œæ‰€ä»¥éœ€è¦æŠŠ CSS æ ·å¼åœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶ä¹Ÿå¡åˆ°é¡µé¢ä¸­ï¼Œä¸€å—è¿”å›ç»™æµè§ˆå™¨)</p> <p><img src="/n-book/assets/img/source_5.c7ffdf7d.png" alt="source_5"></p> <p>åšåˆ°è¿™ä¸ªå¾ˆç®€å•ï¼Œåœ¨æœåŠ¡ç«¯æ¸²æŸ“çš„æ—¶å€™ï¼Œæˆ‘ä»¬æœ‰ staticContext å’Œå­ç»„ä»¶ä»¬åšé€šä¿¡ï¼Œåˆ©ç”¨ staticContext æŠŠ CSS çš„å†…å®¹ç»™è·å–åˆ°ï¼Œå†æ¸²æŸ“åˆ°è¦è¿”å›çš„ HTML ä¸Šå°±å¯ä»¥ã€‚</p> <p>this.props.staticContext åªæœ‰æœåŠ¡ç«¯æ¸²æŸ“æ—¶æ‰æœ‰ï¼Œ<code>_getCss</code> æ–¹æ³•æ˜¯æœåŠ¡ç«¯æ¸²æŸ“æ—¶ isomorphic-style-loader æä¾›çš„æ–¹æ³•ï¼Œå®ƒå¯ä»¥è·å–åˆ° CSS çš„å†…å®¹ã€‚å†æŠŠ css çš„å†…å®¹ç»™ staticContext ä¸‹æ–°å»ºä¸€ä¸ª css å¯¹è±¡ã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/containers/Home/index.js</span>
<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">&quot;./style.css&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Home</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>staticContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>staticContext<span class="token punctuation">.</span>css<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>styles<span class="token punctuation">.</span><span class="token function">_getCss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/server/utils.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> routes<span class="token punctuation">,</span> req<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Provider</span></span> <span class="token attr-name">store</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">StaticRouter</span></span> <span class="token attr-name">location</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>req<span class="token punctuation">.</span>path<span class="token punctuation">}</span></span> <span class="token attr-name">context</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>context<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span><span class="token function">renderRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">StaticRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Provider</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// css çš„å†…å®¹å¡«å……åˆ°å˜é‡cssStr</span>
  <span class="token keyword">const</span> cssStr <span class="token operator">=</span> context<span class="token punctuation">.</span>css <span class="token operator">?</span> context<span class="token punctuation">.</span>css <span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;html&gt;
    &lt;head&gt;
      &lt;title&gt;ssr&lt;/title&gt;
      &lt;style&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cssStr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/style&gt;
    &lt;/head&gt;
    &lt;body&gt;
      &lt;div id=&quot;root&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div&gt;
      &lt;script&gt;
        window.context = {
          state: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
        }
      &lt;/script&gt;
      &lt;script src='/index.js'&gt;&lt;/script&gt;
    &lt;/body&gt;
    &lt;/html&gt;
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><div class="highlighted">Â </div><div class="highlighted">Â </div><br><br><br><br><br><br><div class="highlighted">Â </div><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/server/index.js</span>
<span class="token comment">// ...</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> routes<span class="token punctuation">,</span> req<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&quot;REPLACE&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token number">301</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token constant">NOT_FOUND</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>è¿™æ ·æœåŠ¡ç«¯æ¸²æŸ“å‡ºçš„å†…å®¹å°±å¸¦æœ‰ CSS æ ·å¼äº†ï¼Œè§£å†³äº†å®¢æˆ·ç«¯é‡æ–°æ¸²æŸ“æ—¶ä¼šäº§ç”Ÿçš„é¡µé¢æŠ–åŠ¨é—®é¢˜ã€‚
<img src="/n-book/assets/img/source_6.d6c3698f.png" alt="source_6"></p> <h3 id="å¤šç»„ä»¶ä¸­çš„æ ·å¼å¦‚ä½•æ•´åˆ"><a href="#å¤šç»„ä»¶ä¸­çš„æ ·å¼å¦‚ä½•æ•´åˆ" class="header-anchor">#</a> å¤šç»„ä»¶ä¸­çš„æ ·å¼å¦‚ä½•æ•´åˆ</h3> <p>ä¸Šé¢æœåŠ¡ç«¯æ¸²æŸ“æ˜¯å¾€ staticContext.css å¯¹è±¡é‡Œå¡æ ·å¼æ•°æ®ï¼Œå½“å¤šä¸ªç»„ä»¶åŒæ—¶å†™æ ·å¼æ—¶ï¼Œå°±ä¼šå‰é¢çš„ä¼šè¦†ç›–åé¢çš„æ ·å¼å†…å®¹ã€‚è§£å†³è¿™ä¸ªåˆ™æŠŠ staticContext.css æ”¹å†™æˆä¸€ä¸ªæ•°ç»„å³å¯ã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><div class="highlighted">Â </div><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// src/server/index.js</span>
<span class="token comment">// ...</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span> css<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> routes<span class="token punctuation">,</span> req<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&quot;REPLACE&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token number">301</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token constant">NOT_FOUND</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>server/src/components/Header/index.jsï¼Œä¾‹å¦‚ Header ç»„ä»¶æ–°å¢ css å†…å®¹ï¼š</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token comment">// ...</span>
<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">&quot;./style.css&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Header</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>staticContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>staticContext<span class="token punctuation">.</span>css<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>styles<span class="token punctuation">.</span><span class="token function">_getCss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token comment">// ...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>server/src/App.jsï¼ŒHeader ç»„ä»¶ä¸Šæ²¡æœ‰ staticContextï¼Œæ‰€ä»¥ä»å®ƒçš„çˆ¶ç»„ä»¶ App ä¼ è¿‡å»ã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted">Â </div><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// ...</span>
<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token parameter">props</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Header</span></span> <span class="token attr-name">staticContext</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>staticContext<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span><span class="token function">renderRoutes</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>route<span class="token punctuation">.</span>routes<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>server/src/server/utils.jsï¼Œå¤„ç† context.css æ•°ç»„ç”¨äºæ­£å¸¸æ˜¾ç¤ºã€‚</p> <div class="language-jsx line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted">Â </div><br><br><br><br><br><br><br><br><br></div><pre class="language-jsx"><code><span class="token comment">// ...</span>
<span class="token keyword">const</span> cssStr <span class="token operator">=</span> context<span class="token punctuation">.</span>css<span class="token punctuation">.</span>length <span class="token operator">?</span> context<span class="token punctuation">.</span>css<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;ssr&lt;/title&gt;
    &lt;style&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cssStr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/style&gt;
  &lt;/head&gt;
  // ...
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>å¯ä»¥è¾“å‡º context.css å’Œ cssStr åšå¯¹æ¯”
<img src="/n-book/assets/img/console_5.73bad898.png" alt="console_5"></p> <h3 id="é«˜é˜¶ç»„ä»¶å°è£…æ¥ç²¾ç®€ä»£ç "><a href="#é«˜é˜¶ç»„ä»¶å°è£…æ¥ç²¾ç®€ä»£ç " class="header-anchor">#</a> é«˜é˜¶ç»„ä»¶å°è£…æ¥ç²¾ç®€ä»£ç </h3> <p>ä¸Šé¢çš„é—®é¢˜åœ¨äºè¦å†™å¾ˆå¤šéé‡å¤ä»£ç ï¼Œæ¯ä¸€ä¸ªç»„ä»¶éƒ½è¦å†™æ ·å¼ï¼Œéƒ½è¦åœ¨ç»„ä»¶æ–‡ä»¶é‡ŒæŠŠæ ·å¼å†…å®¹æ³¨å…¥åˆ° staticContext ä¸­ã€‚é‚£æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é«˜é˜¶ç»„ä»¶æ¥ç»™å®ƒå°è£…ä¸€å±‚æ¥ç®€åŒ–ä»£ç ã€‚</p> <p>åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª withStyle.css æ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ªå°è£…åçš„é«˜é˜¶ç»„ä»¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¦å°è£…çš„ç»„ä»¶ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ ·å¼çš„å†…å®¹ï¼š
server/src/withStyle.js</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// è¿™ä¸ªå‡½æ•°ï¼Œæ˜¯ç”Ÿæˆé«˜é˜¶ç»„ä»¶çš„å‡½æ•°</span>
<span class="token comment">// è¿™ä¸ªå‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªç»„ä»¶</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token parameter">DecoratedComponent<span class="token punctuation">,</span> styles</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¿”å›çš„è¿™ä¸ªç»„ä»¶ï¼Œå«åšé«˜é˜¶ç»„ä»¶</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">NewComponent</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>staticContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>staticContext<span class="token punctuation">.</span>css<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>styles<span class="token punctuation">.</span><span class="token function">_getCss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å°†åŸç»„ä»¶ä¸Šæ‰€æœ‰çš„propsä¼ ç»™æ–°çš„ç»„ä»¶DecoratedComponent</span>
      <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">DecoratedComponent</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">this</span><span class="token punctuation">.</span><span class="token attr-value">props</span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>è¿™æ ·çš„è¯ï¼Œå°±å¯ä»¥åœ¨ç»„ä»¶é‡Œä½¿ç”¨é«˜é˜¶ç»„ä»¶å»ç®€åŒ–ä»£ç ï¼š
server/src/containers/Home/index.js</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">import</span> withStyle <span class="token keyword">from</span> <span class="token string">&quot;../../withStyle&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>

<span class="token keyword">const</span> ExportHome <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>
  mapStateToProps<span class="token punctuation">,</span>
  mapStateToDispatch
<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">withStyle</span><span class="token punctuation">(</span>Home<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="seo"><a href="#seo" class="header-anchor">#</a> SEO</h2> <p><a href="https://github.com/nfl/react-helmet" target="_blank" rel="noopener noreferrer">react-helmet<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> æ¥å¤„ç†é¡µé¢ TDKã€‚</p> <h2 id="ä½¿ç”¨é¢„æ¸²æŸ“è§£å†³-seo-é—®é¢˜çš„æ–°æ€è·¯"><a href="#ä½¿ç”¨é¢„æ¸²æŸ“è§£å†³-seo-é—®é¢˜çš„æ–°æ€è·¯" class="header-anchor">#</a> ä½¿ç”¨é¢„æ¸²æŸ“è§£å†³ SEO é—®é¢˜çš„æ–°æ€è·¯</h2> <p>é’ˆå¯¹çº¯å®¢æˆ·ç«¯æ¸²æŸ“çš„é¡µé¢ï¼Œå¯ä»¥ä½¿ç”¨é¢„æ¸²æŸ“æŠ€æœ¯æ¥ä¼˜åŒ– SEOã€‚</p> <p><img src="/n-book/assets/img/seo_1.d4fe652b.png" alt="seo_1"></p> <p>prerender
<a href="https://github.com/prerender/prerender" target="_blank" rel="noopener noreferrer">https://github.com/prerender/prerender<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>ç”¨ Nginx å¤„ç†ï¼Œæ˜¯çˆ¬è™«è®¿é—®é¡µé¢ï¼Œå°±æŠŠå®¢æˆ·ç«¯æ¸²æŸ“åå®Œæ•´çš„é¡µé¢è¿”å›ç»™çˆ¬è™«ã€‚</p> <p>æ˜¯æ­£å¸¸ç”¨æˆ·åˆ™æ­£å¸¸è¿”å›é¡µé¢ã€‚</p> <p><img src="/n-book/assets/img/seo_2.8b3f83d6.png" alt="seo_2"></p> <p><a href="https://prerender.io/" target="_blank" rel="noopener noreferrer">https://prerender.io/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/NiroDu/N-book/edit/master/docs/react/react_ssr.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘æ­¤é¡µ</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°: </span> <span class="time">5/9/2019, 6:29:58 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/n-book/react/libs_with_react.html" class="prev">
          Libs with React
        </a></span> <span class="next"><a href="/n-book/react/redux_createstore.html">
          è®²è®² Redux createStore çš„å®ç°åŸç†
        </a>
        â†’
      </span></p></div> </div> <!----></div></div>
    <script src="/n-book/assets/js/app.00669d2d.js" defer></script><script src="/n-book/assets/js/3.a2cc91fe.js" defer></script>
  </body>
</html>
